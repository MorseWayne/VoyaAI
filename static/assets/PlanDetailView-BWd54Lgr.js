import{f as T,a as d,c as f,b as t,m as nt,u as D,n as N,F as J,r as X,t as k,h as S,l as at,p as h,o as dt,q as zt,s as ct,k as W,T as st,e as P,x as qt,y as Ut,w as Vt,v as Wt,i as Gt,z as kt,A as G,B as Jt,g as Kt}from"./index-0Jbrg61l.js";import{u as lt,f as $t,d as _t,e as et,g as Qt}from"./plan-BwXcCmb9.js";import{p as Xt,a as Yt,d as Zt}from"./plans-CXcnj4pw.js";import{s as te}from"./locations-BO7ne7Nk.js";import"./client-C1hk53qU.js";function ee(n={}){const{enabled:b=!0}=n,l=lt(),s=T(null),o=T(null);function u(y,x){if(!b){y.preventDefault(),y.stopPropagation();return}s.value=x,y.dataTransfer.effectAllowed="move",y.dataTransfer.setData("text/plain",String(x))}function w(y,x){y.preventDefault(),b&&(y.dataTransfer.dropEffect="move",o.value=x)}function _(){o.value=null}async function p(y,x,c){if(y.preventDefault(),!b)return;const $=s.value;if(o.value=null,$===null||$===x){s.value=null;return}await l.reorderLocations(c,$,x),s.value=null}function r(){s.value=null,o.value=null}return{dragIndex:s,dragOverIndex:o,onDragStart:u,onDragOver:w,onDragLeave:_,onDrop:p,onDragEnd:r}}const ne={class:"mb-4",style:{"border-bottom":"1px solid var(--border-color)"}},ae={class:"flex gap-2 overflow-x-auto py-2 -mx-1 px-1 min-h-[44px] items-center"},se=["onClick"],le={__name:"DayTabs",props:{days:{type:Array,required:!0}},setup(n){const b=lt();return(l,s)=>(d(),f("div",ne,[t("div",ae,[t("button",{type:"button",onClick:s[0]||(s[0]=o=>D(b).activeDetailTab="overview"),class:N(["flex-shrink-0 px-4 py-2 rounded-full text-sm font-medium transition whitespace-nowrap",D(b).activeDetailTab==="overview"?"bg-cyan-600 text-white shadow-lg shadow-cyan-500/20":"t-text-sub"]),style:nt(D(b).activeDetailTab!=="overview"?"background: var(--bg-card); border: 1px solid var(--border-color);":"")}," 总览 ",6),(d(!0),f(J,null,X(n.days,(o,u)=>(d(),f("button",{key:u,type:"button",onClick:w=>D(b).activeDetailTab=u,class:N(["flex-shrink-0 px-4 py-2 rounded-full text-sm font-medium transition whitespace-nowrap",D(b).activeDetailTab===u?"bg-cyan-600 text-white shadow-lg shadow-cyan-500/20":"t-text-sub"]),style:nt(D(b).activeDetailTab!==u?"background: var(--bg-card); border: 1px solid var(--border-color);":"")}," 第 "+k(u+1)+" 天 ",15,se))),128))])]))}},oe={class:"space-y-4"},re=["onClick"],ie={class:"flex justify-between items-center"},ue={class:"font-bold t-text group-hover:text-cyan-500 transition"},de={class:"text-sm t-text-muted"},ce={class:"text-sm t-text-sub mt-1"},ve={__name:"DayOverview",props:{days:{type:Array,required:!0}},setup(n){const b=lt();return(l,s)=>(d(),f("div",oe,[(d(!0),f(J,null,X(n.days,(o,u)=>(d(),f("div",{key:u,onClick:w=>D(b).activeDetailTab=u,class:"rounded-xl p-4 cursor-pointer transition group",style:{background:"var(--bg-card)",border:"1px solid var(--border-color)"}},[t("div",ie,[t("span",ue,"第 "+k(u+1)+" 天",1),t("span",de,k(o.date?new Date(o.date).toLocaleDateString("zh-CN",{month:"long",day:"numeric"}):`第 ${u+1} 天`),1)]),t("p",ce,k((o.segments||[]).length>0?o.segments.length+1:0)+" 个地点",1)],8,re))),128))]))}},me={class:"timeline-item group relative"},fe={class:"timeline-rail"},pe={class:"text-sm font-bold font-mono"},ye={class:"timeline-time"},xe={key:0,class:"timeline-line"},ge={class:"flex-1 min-w-0 pb-2"},be={class:"flex justify-between items-start gap-3"},he={class:"min-w-0 flex-1"},we={class:"flex items-center flex-wrap gap-2 mb-1.5"},ke={class:"font-bold t-heading text-lg leading-snug"},$e={key:0,class:"px-2 py-0.5 rounded-full text-xs font-bold shadow-sm",style:{background:"var(--badge-start-bg)",color:"var(--badge-start-text)"}},_e={key:1,class:"px-2 py-0.5 rounded-full text-xs font-bold shadow-sm",style:{background:"var(--badge-end-bg)",color:"var(--badge-end-text)"}},De={class:"text-sm t-text-sub flex items-center gap-1.5 mb-3"},Te={class:"truncate opacity-80"},Se={class:"flex items-center gap-4 flex-wrap"},Ce={class:"inline-flex items-center gap-2 rounded-lg px-2.5 py-1",style:{background:"var(--bg-inset)",border:"1px solid var(--border-subtle)"}},Le={class:"text-xs t-text-sub font-medium"},Ie=["value"],ut={__name:"LocationCard",props:{location:{type:Object,default:null},index:{type:Number,required:!0},isLast:{type:Boolean,default:!1},roleLabel:{type:String,default:null},arrivalHm:{type:String,default:"--"},stayMinutes:{type:Number,default:0},dayIndex:{type:Number,default:0},departureHm:{type:String,default:null},canEditStart:{type:Boolean,default:!1}},emits:["insert","remove","updateStay","editStart"],setup(n,{emit:b}){const l=n,s=b,o=h(()=>{var p;return(p=l.location)!=null&&p.name?l.location.name:l.roleLabel==="起点"?"起点（待补充）":l.roleLabel==="终点"?"终点（待补充）":"未知地点"}),u=h(()=>{var p,r,y;return((p=l.location)==null?void 0:p.address)||((r=l.location)==null?void 0:r.city)||((y=l.location)==null?void 0:y.name)||"未知地址"}),w=h(()=>l.departureHm&&l.stayMinutes>0?`到达 ${l.arrivalHm} · 离开 ${l.departureHm}`:`到达 ${l.arrivalHm}`);function _(p){const r=Math.max(0,Math.min(480,parseInt(p.target.value,10)||0));s("updateStay",l.dayIndex,l.index,r)}return(p,r)=>(d(),f("div",me,[t("div",fe,[t("div",{class:N(["timeline-node",{"bg-emerald-500 border-emerald-300 text-white shadow-emerald-500/30":n.roleLabel==="起点","bg-rose-500 border-rose-300 text-white shadow-rose-500/30":n.isLast&&n.roleLabel==="终点"}])},[t("span",pe,k(n.index+1),1)],2),t("div",ye,k(n.arrivalHm),1),n.isLast?S("",!0):(d(),f("div",xe))]),t("div",ge,[t("div",{class:N(["location-card",{"is-start":n.roleLabel==="起点","is-end":n.roleLabel==="终点"}])},[t("div",be,[t("div",he,[t("div",we,[t("h4",ke,k(o.value),1),n.roleLabel==="起点"?(d(),f("span",$e,"起点")):S("",!0),n.roleLabel==="终点"?(d(),f("span",_e,"终点")):S("",!0)]),t("p",De,[r[5]||(r[5]=t("i",{class:"fas fa-map-marker-alt text-cyan-500/70 text-xs"},null,-1)),t("span",Te,k(u.value),1)]),t("div",Se,[t("div",Ce,[r[6]||(r[6]=t("i",{class:"far fa-clock t-text-muted text-xs"},null,-1)),t("span",Le,k(w.value),1)]),t("div",{class:"inline-flex items-center gap-1.5",onClick:r[0]||(r[0]=at(()=>{},["stop"]))},[r[7]||(r[7]=t("i",{class:"fas fa-hourglass-half t-text-muted text-xs"},null,-1)),r[8]||(r[8]=t("span",{class:"text-xs t-text-muted"},"停留",-1)),t("input",{type:"number",min:"0",max:"480",step:"15",value:n.stayMinutes,class:"w-14 text-xs text-center border-0 bg-transparent py-0.5 focus:ring-0 font-medium transition-colors",style:{"border-bottom":"1px solid var(--border-color)",color:"var(--text-primary)"},onChange:_},null,40,Ie),r[9]||(r[9]=t("span",{class:"text-xs t-text-muted"},"分",-1))])])]),t("div",{class:"flex flex-col gap-1 flex-shrink-0 opacity-0 group-hover:opacity-100 transition-opacity duration-200",onClick:r[4]||(r[4]=at(()=>{},["stop"]))},[n.canEditStart?(d(),f("button",{key:0,type:"button",class:"w-8 h-8 flex items-center justify-center rounded-lg text-amber-600 hover:bg-amber-500 hover:text-white transition shadow-sm",style:{background:"var(--nav-active-bg)"},onClick:r[1]||(r[1]=y=>s("editStart")),title:"修改起点"},[...r[10]||(r[10]=[t("i",{class:"fas fa-edit text-xs"},null,-1)])])):S("",!0),t("button",{type:"button",class:"w-8 h-8 flex items-center justify-center rounded-lg text-cyan-600 hover:bg-cyan-500 hover:text-white transition shadow-sm",style:{background:"var(--nav-active-bg)"},onClick:r[2]||(r[2]=y=>s("insert",n.isLast?null:n.index+1)),title:"在此处插入下一站"},[...r[11]||(r[11]=[t("i",{class:"fas fa-plus text-xs"},null,-1)])]),t("button",{type:"button",class:"w-8 h-8 flex items-center justify-center rounded-lg t-text-muted hover:bg-rose-500/10 hover:text-rose-500 transition shadow-sm",style:{background:"var(--bg-inset)"},onClick:r[3]||(r[3]=y=>s("remove",n.index,n.isLast)),title:"删除此地点"},[...r[12]||(r[12]=[t("i",{class:"fas fa-trash-alt text-xs"},null,-1)])])])])],2)])]))}},Me={driving:"fa-car",transit:"fa-bus",walking:"fa-walking",cycling:"fa-bicycle",flight:"fa-plane",train:"fa-train"};function ot(n){var o,u,w,_,p,r;if(!n)return"driving";if(n.type==="flight"||n.type==="train")return n.type;const b=((o=n.details)==null?void 0:o.departure_time)||((u=n.origin)==null?void 0:u.departure_time),l=((w=n.details)==null?void 0:w.arrival_time)||((_=n.destination)==null?void 0:_.arrival_time);if(!b||!l)return n.type;const s=(((p=n.origin)==null?void 0:p.name)||"")+(((r=n.destination)==null?void 0:r.name)||"");return/机场|航空|航班/i.test(s)?"flight":/站|火车站|高铁|动车|列车/i.test(s)?"train":n.type}function Dt(n){const b=typeof n=="string"?n:ot(n);return Me[b]||"fa-car"}function je(n){var s,o,u;if(!n)return"驾车";const b=ot(n);return{driving:"驾车",transit:((s=n.details)==null?void 0:s.display_label)==="城际交通"?"城际交通":"公交",walking:"步行",cycling:"骑行",flight:((o=n.details)==null?void 0:o.flight_no)||"航班",train:((u=n.details)==null?void 0:u.train_no)||"高铁"}[b]||"驾车"}const Re={class:"transport-connector-row"},Oe={class:"flex-1 min-w-0 py-1"},Ae={class:"font-semibold"},Fe={class:"font-mono text-[11px] opacity-80"},Be={class:"font-mono text-[11px] opacity-60 ml-0.5"},He={__name:"TransportConnector",props:{segment:{type:Object,required:!0},index:{type:Number,required:!0}},emits:["openDetail"],setup(n,{emit:b}){const l=n,s=b,o=h(()=>Dt(l.segment)),u=h(()=>je(l.segment)),w=h(()=>ot(l.segment)),_=h(()=>w.value==="flight"||w.value==="train"),p=h(()=>{var m,v;return((m=l.segment.details)==null?void 0:m.departure_time)||((v=l.segment.origin)==null?void 0:v.departure_time)}),r=h(()=>{var m,v;return((m=l.segment.details)==null?void 0:m.arrival_time)||((v=l.segment.destination)==null?void 0:v.arrival_time)}),y=h(()=>p.value&&r.value?`${p.value} → ${r.value}`:p.value||r.value||""),x=h(()=>{if(p.value&&r.value){const m=_t(p.value,r.value);if(m>0)return m}return l.segment.duration_minutes!=null?l.segment.duration_minutes*60:null}),c=h(()=>_.value&&y.value?y.value:x.value!=null?$t(x.value):"--"),$=h(()=>l.segment.distance_km!=null&&l.segment.distance_km>0?`${l.segment.distance_km}km`:_.value?"—":"--");return(m,v)=>(d(),f("div",Re,[v[3]||(v[3]=t("div",{class:"timeline-rail-spacer"},[t("div",{class:"timeline-line-through"})],-1)),t("div",Oe,[t("div",{onClick:v[0]||(v[0]=g=>s("openDetail",n.index)),class:"transport-badge group/conn",title:"点击查看详情"},[t("i",{class:N(["fas",o.value,"text-xs"])},null,2),t("span",Ae,k(u.value),1),v[1]||(v[1]=t("span",{class:"transport-badge-divider"},null,-1)),t("span",Fe,k(c.value),1),t("span",Be,"("+k($.value)+")",1),v[2]||(v[2]=t("i",{class:"fas fa-chevron-right text-[10px] opacity-40 ml-1 group-hover/conn:opacity-100 transition-opacity"},null,-1))])])]))}},Pe=["onClick"],Ee={class:"text-sm font-medium"},Ne={__name:"TransportDropdown",props:{show:Boolean,triggerRect:{type:Object,default:null}},emits:["select","close"],setup(n,{emit:b}){const l=n,s=b,o=T(null),u=T({}),w=[{mode:"driving",icon:"fa-car",label:"驾车"},{mode:"transit",icon:"fa-bus",label:"公交/地铁"},{mode:"train",icon:"fa-train",label:"高铁/火车"},{mode:"flight",icon:"fa-plane",label:"飞机"},{mode:"walking",icon:"fa-walking",label:"步行"},{mode:"cycling",icon:"fa-bicycle",label:"骑行"}];function _(){if(!l.triggerRect)return;const y=l.triggerRect;let x=y.bottom+8;const c=Math.min(y.left,window.innerWidth-170);x+220>window.innerHeight&&(x=y.top-220-8),u.value={top:`${x}px`,left:`${c}px`}}function p(y){o.value&&!o.value.contains(y.target)&&s("close")}dt(()=>{_(),zt(()=>document.addEventListener("click",p))}),ct(()=>{document.removeEventListener("click",p)});function r(y){s("select",y),s("close")}return(y,x)=>(d(),W(st,{to:"body"},[n.show?(d(),f("div",{key:0,ref_key:"dropdownRef",ref:o,class:"fixed z-[100] rounded-xl shadow-2xl py-1.5 w-40 animate-fade-in",style:nt({...u.value,background:"var(--dropdown-bg)",border:"1px solid var(--dropdown-border)"})},[(d(),f(J,null,X(w,c=>t("button",{key:c.mode,onClick:$=>r(c.mode),class:"w-full text-left px-4 py-2.5 transition flex items-center gap-3 group",style:{color:"var(--dropdown-text)"}},[t("i",{class:N(["fas",c.icon,"w-5 text-center"]),style:{color:"var(--dropdown-icon)"}},null,2),t("span",Ee,k(c.label),1)],8,Pe)),64))],4)):S("",!0)]))}},ze={key:0,class:"fixed inset-0 z-[61]"},qe={class:"flex justify-between items-center mb-4"},Ue={class:"t-text-sub text-sm space-y-3 mb-6"},Ve={class:"py-1.5",style:{"border-bottom":"1px solid var(--border-subtle)"}},We={class:"flex items-center gap-2 font-medium",style:{color:"var(--text-primary)"}},Ge={class:"py-1.5 flex justify-between",style:{"border-bottom":"1px solid var(--border-subtle)"}},Je={class:"py-1.5 flex justify-between",style:{"border-bottom":"1px solid var(--border-subtle)"}},Ke={key:0,class:"py-1.5 flex justify-between",style:{"border-bottom":"1px solid var(--border-subtle)"}},Qe={key:1,class:"py-1.5 flex justify-between",style:{"border-bottom":"1px solid var(--border-subtle)"}},Xe={class:"py-1.5 flex justify-between",style:{"border-bottom":"1px solid var(--border-subtle)"}},Ye={class:"py-1.5 flex justify-between"},Ze={__name:"TransportDetailModal",props:{show:Boolean,segment:{type:Object,default:null}},emits:["close","change"],setup(n,{emit:b}){const l=n,s=b,o=h(()=>ot(l.segment)),u=h(()=>Dt(l.segment)),w=h(()=>{var C,I,F;if(!l.segment)return"驾车";const g=l.segment;return{driving:"驾车",transit:((C=g.details)==null?void 0:C.display_label)==="城际交通"?"城际交通":"公交/地铁",walking:"步行",cycling:"骑行",flight:((I=g.details)==null?void 0:I.flight_no)||"航班",train:((F=g.details)==null?void 0:F.train_no)||"高铁/火车"}[o.value]||"驾车"}),_=h(()=>{var g,i,C,I;return((i=(g=l.segment)==null?void 0:g.details)==null?void 0:i.departure_time)||((I=(C=l.segment)==null?void 0:C.origin)==null?void 0:I.departure_time)}),p=h(()=>{var g,i,C,I;return((i=(g=l.segment)==null?void 0:g.details)==null?void 0:i.arrival_time)||((I=(C=l.segment)==null?void 0:C.destination)==null?void 0:I.arrival_time)}),r=h(()=>{var g;if(_.value&&p.value){const i=_t(_.value,p.value);if(i>0)return i}return((g=l.segment)==null?void 0:g.duration_minutes)!=null?l.segment.duration_minutes*60:null}),y=h(()=>r.value!=null?$t(r.value):"--"),x=h(()=>{var g;return((g=l.segment)==null?void 0:g.distance_km)!=null&&l.segment.distance_km>0?`${l.segment.distance_km} km`:o.value==="flight"||o.value==="train"?"—":"--"}),c=h(()=>{var g,i;return((i=(g=l.segment)==null?void 0:g.origin)==null?void 0:i.name)||"起点"}),$=h(()=>{var g,i;return((i=(g=l.segment)==null?void 0:g.destination)==null?void 0:i.name)||"终点"}),m=h(()=>o.value==="flight"||o.value==="train"),v=h(()=>{var g,i,C,I,F,K;return((g=l.segment)==null?void 0:g.type)==="flight"&&((C=(i=l.segment)==null?void 0:i.details)==null?void 0:C.flight_no)||((I=l.segment)==null?void 0:I.type)==="train"&&((K=(F=l.segment)==null?void 0:F.details)==null?void 0:K.train_no)});return(g,i)=>{var C;return d(),W(st,{to:"body"},[n.show&&n.segment?(d(),f("div",ze,[t("div",{class:"absolute inset-0 backdrop-blur-sm",style:{background:"var(--modal-overlay)"},onClick:i[0]||(i[0]=I=>s("close"))}),t("div",{class:"absolute bottom-0 left-0 right-0 md:top-1/2 md:left-1/2 md:bottom-auto md:-translate-x-1/2 md:-translate-y-1/2 md:w-[400px] max-h-[90vh] overflow-y-auto md:rounded-2xl rounded-t-2xl shadow-2xl p-6",style:{background:"var(--modal-bg)"},onClick:i[3]||(i[3]=at(()=>{},["stop"]))},[t("div",qe,[i[5]||(i[5]=t("h3",{class:"text-lg font-bold t-heading"},"交通方式详情",-1)),t("button",{type:"button",onClick:i[1]||(i[1]=I=>s("close")),class:"w-8 h-8 flex items-center justify-center rounded-full t-text-sub transition",style:{background:"var(--bg-inset)"}},[...i[4]||(i[4]=[t("i",{class:"fas fa-times"},null,-1)])])]),t("div",Ue,[t("div",Ve,[t("div",We,[t("i",{class:N(["fas",u.value,"text-cyan-600"])},null,2),P(" "+k(w.value),1)])]),t("div",Ge,[i[6]||(i[6]=t("span",{class:"t-text-muted"},"起点",-1)),t("span",null,k(c.value),1)]),t("div",Je,[i[7]||(i[7]=t("span",{class:"t-text-muted"},"终点",-1)),t("span",null,k($.value),1)]),m.value&&(_.value||p.value)?(d(),f("div",Ke,[i[8]||(i[8]=t("span",{class:"t-text-muted"},"时间",-1)),t("span",null,k(_.value||"--")+" → "+k(p.value||"--"),1)])):S("",!0),m.value&&((C=n.segment.details)!=null&&C.seat_info)?(d(),f("div",Qe,[i[9]||(i[9]=t("span",{class:"t-text-muted"},"座位",-1)),t("span",null,k(n.segment.details.seat_info),1)])):S("",!0),t("div",Xe,[i[10]||(i[10]=t("span",{class:"t-text-muted"},"时长",-1)),t("span",null,k(y.value),1)]),t("div",Ye,[i[11]||(i[11]=t("span",{class:"t-text-muted"},"距离",-1)),t("span",null,k(x.value),1)])]),v.value?S("",!0):(d(),f("button",{key:0,type:"button",class:"w-full py-3 rounded-xl border-2 border-cyan-500 text-cyan-600 font-medium transition",onClick:i[2]||(i[2]=I=>s("change"))},[...i[12]||(i[12]=[t("i",{class:"fas fa-exchange-alt mr-2"},null,-1),P(" 更改交通方式 ",-1)])]))])])):S("",!0)])}}},tn={key:0,class:"fixed inset-0 z-[60] flex items-center justify-center"},en={class:"flex justify-between items-center mb-6"},nn={class:"text-lg font-bold t-heading"},an={__name:"BaseModal",props:{show:Boolean,title:{type:String,default:""},maxWidth:{type:String,default:"500px"}},emits:["close"],setup(n,{emit:b}){const l=b;return(s,o)=>(d(),W(st,{to:"body"},[n.show?(d(),f("div",tn,[t("div",{class:"absolute inset-0 backdrop-blur-sm transition-opacity",style:{background:"var(--modal-overlay)"},onClick:o[0]||(o[0]=u=>l("close"))}),t("div",{class:"relative w-[calc(100%-2rem)] rounded-2xl shadow-2xl p-6 animate-fade-in",style:nt({maxWidth:n.maxWidth,background:"var(--modal-bg)"})},[t("div",en,[t("h3",nn,k(n.title),1),t("button",{onClick:o[1]||(o[1]=u=>l("close")),class:"w-8 h-8 flex items-center justify-center rounded-full t-text-sub transition",style:{background:"var(--bg-inset)"}},[...o[2]||(o[2]=[t("i",{class:"fas fa-times"},null,-1)])])]),qt(s.$slots,"default")],4)])):S("",!0)]))}},sn={class:"relative mb-4"},ln={class:"flex gap-2 mb-4 overflow-x-auto pb-2"},on={class:"h-64 overflow-y-auto space-y-2"},rn={key:0,class:"text-center py-4 t-text-muted"},un={key:1,class:"text-center t-text-muted py-10"},dn={key:0,class:"text-xs mt-1 text-cyan-600"},cn={key:2,class:"text-center py-4 t-text-muted"},vn=["onClick"],mn={class:"font-medium text-sm t-text"},fn={class:"text-xs t-text-muted truncate w-64"},pn={__name:"AddLocationModal",props:{show:Boolean,title:{type:String,default:"添加行程地点"},city:{type:String,default:""},insertAtIndex:{type:[Number,null],default:null}},emits:["close","select","openTicketImport"],setup(n,{emit:b}){const l=n,s=b,o=T(""),u=T([]),w=T(!1);let _=null;function p(x){_&&clearTimeout(_),x.trim()&&(_=setTimeout(async()=>{w.value=!0;try{u.value=await te(x,l.city)}catch(c){console.error(c)}finally{w.value=!1}},500))}function r(x){s("select",{name:x.name,address:x.address,city:x.city||l.city||"",lat:x.location?parseFloat(x.location.split(",")[1]):null,lng:x.location?parseFloat(x.location.split(",")[0]):null})}function y(){o.value="",u.value=[],s("close")}return(x,c)=>(d(),W(an,{show:n.show,title:n.title,onClose:y},{default:Ut(()=>[t("div",sn,[c[3]||(c[3]=t("i",{class:"fas fa-search absolute left-4 top-1/2 -translate-y-1/2 t-text-muted"},null,-1)),Vt(t("input",{"onUpdate:modelValue":c[0]||(c[0]=$=>o.value=$),type:"text",placeholder:"搜索地点...",class:"w-full pl-11 pr-4 py-3 rounded-xl border outline-none transition",onInput:c[1]||(c[1]=$=>p(o.value))},null,544),[[Wt,o.value]])]),t("div",ln,[c[5]||(c[5]=t("button",{class:"flex-shrink-0 px-3 py-1.5 text-cyan-600 text-xs rounded-lg font-medium flex items-center gap-1",style:{background:"var(--nav-active-bg)",border:"1px solid rgba(6,182,212,0.2)"}},[t("i",{class:"fas fa-search"}),P(" 搜索 ")],-1)),t("button",{type:"button",onClick:c[2]||(c[2]=$=>{y(),s("openTicketImport")}),class:"flex-shrink-0 px-3 py-1.5 text-cyan-600 text-xs rounded-lg font-medium flex items-center gap-1 transition",style:{background:"var(--nav-active-bg)",border:"1px solid rgba(6,182,212,0.2)"}},[...c[4]||(c[4]=[t("i",{class:"fas fa-camera"},null,-1),P(" 截图导入 ",-1)])])]),t("div",on,[w.value?(d(),f("div",rn,[...c[6]||(c[6]=[t("i",{class:"fas fa-spinner fa-spin"},null,-1),P(" 搜索中... ",-1)])])):u.value.length===0&&!o.value?(d(),f("div",un,[c[7]||(c[7]=t("i",{class:"fas fa-map-marked-alt text-3xl mb-2 opacity-50"},null,-1)),c[8]||(c[8]=t("p",{class:"text-sm"},"输入关键词搜索地点",-1)),n.insertAtIndex!==null?(d(),f("p",dn,"将添加为当前站点的下一站")):S("",!0)])):u.value.length===0?(d(),f("div",cn,"未找到相关地点")):S("",!0),(d(!0),f(J,null,X(u.value,$=>(d(),f("div",{key:$.name+$.address,onClick:m=>r($),class:"p-3 rounded-lg cursor-pointer transition flex items-center gap-3",style:{"border-bottom":"1px solid var(--border-subtle)"}},[c[9]||(c[9]=t("div",{class:"w-8 h-8 rounded-full flex items-center justify-center t-text-muted flex-shrink-0",style:{background:"var(--bg-inset)"}},[t("i",{class:"fas fa-map-pin"})],-1)),t("div",null,[t("div",mn,k($.name),1),t("div",fn,k($.district||"")+" "+k($.address||""),1)])],8,vn))),128))])]),_:1},8,["show","title"]))}},yn={key:0,class:"fixed inset-0 z-[70]"},xn={class:"flex justify-between items-center mb-4"},gn={class:"text-lg font-bold t-heading"},bn={class:"text-sm t-text-sub mb-3"},hn={key:0},wn=["src"],kn={key:0,class:"mt-3 text-sm text-cyan-600"},$n={key:1,class:"mt-3 text-sm text-red-500"},_n=["disabled"],Dn={__name:"TicketImportModal",props:{show:Boolean,title:{type:String,default:"导入航班 / 车票"},expectFlightOnly:{type:Boolean,default:!1}},emits:["close","imported"],setup(n,{emit:b}){const l=n,s=b,o=T(null),u=T(""),w=T(""),_=T(!1);let p=null;function r(m){const v=new FileReader;v.onload=()=>{o.value=v.result,w.value=""},v.readAsDataURL(m)}function y(m){const v=m.target.files[0];v&&v.type.startsWith("image/")&&r(v)}function x(){var m;(m=document.getElementById("ticket-file-input"))==null||m.click()}async function c(){if(o.value){_.value=!0,u.value="正在识别票据…",w.value="";try{const m=await Xt(o.value);if(m.type==="unknown"||m.error){w.value=m.error||"无法识别为机票或火车票",u.value="";return}if(l.expectFlightOnly&&m.type!=="flight"){w.value="请上传机票截图",u.value="";return}u.value=l.expectFlightOnly?"已更新为航班":"已加入当天行程",s("imported",m),s("close")}catch(m){w.value=m.message||"识别失败，请重试",u.value=""}finally{_.value=!1}}}function $(){o.value=null,u.value="",w.value="",s("close")}return dt(()=>{p=m=>{var v,g;if(l.show&&((g=(v=m.clipboardData)==null?void 0:v.files)!=null&&g.length)){const i=Array.from(m.clipboardData.files).find(C=>C.type.startsWith("image/"));i&&(m.preventDefault(),r(i))}},window.addEventListener("paste",p)}),ct(()=>{p&&window.removeEventListener("paste",p)}),(m,v)=>(d(),W(st,{to:"body"},[n.show?(d(),f("div",yn,[t("div",{class:"absolute inset-0 backdrop-blur-sm",style:{background:"var(--modal-overlay)"},onClick:$}),t("div",{class:"absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[calc(100%-2rem)] max-w-md rounded-2xl shadow-2xl p-6",style:{background:"var(--modal-bg)"},onClick:v[0]||(v[0]=at(()=>{},["stop"]))},[t("div",xn,[t("h3",gn,k(n.title),1),t("button",{type:"button",onClick:$,class:"w-8 h-8 flex items-center justify-center rounded-full t-text-sub transition",style:{background:"var(--bg-inset)"}},[...v[1]||(v[1]=[t("i",{class:"fas fa-times"},null,-1)])])]),t("p",bn,k(n.expectFlightOnly?"上传机票截图，自动识别航班信息并更新该段交通":"上传或粘贴机票、高铁票等截图，自动识别并加入当天行程"),1),t("div",{onClick:x,class:"border-2 border-dashed rounded-xl p-6 text-center cursor-pointer hover:border-cyan-400 transition",style:{"border-color":"var(--border-color)"}},[t("input",{id:"ticket-file-input",type:"file",accept:"image/*",class:"hidden",onChange:y},null,32),o.value?(d(),f("img",{key:1,src:o.value,class:"max-h-48 mx-auto rounded-lg object-contain",alt:"预览"},null,8,wn)):(d(),f("div",hn,[...v[2]||(v[2]=[t("i",{class:"fas fa-image text-4xl t-text-muted mb-2"},null,-1),t("p",{class:"text-sm t-text-sub"},[P("点击选择或 "),t("kbd",{class:"px-1.5 py-0.5 rounded text-xs",style:{background:"var(--bg-inset)"}},"Ctrl+V"),P(" 粘贴截图")],-1)])]))]),u.value?(d(),f("div",kn,k(u.value),1)):S("",!0),w.value?(d(),f("div",$n,k(w.value),1)):S("",!0),t("button",{type:"button",disabled:!o.value||_.value,class:N(["mt-4 w-full py-3 rounded-xl bg-primary text-white font-medium transition",{"opacity-50 cursor-not-allowed":!o.value||_.value}]),onClick:c},k(_.value?"识别中...":"识别并导入"),11,_n)])])):S("",!0)]))}},Tn={class:"max-w-6xl mx-auto"},Sn={key:0,class:"text-center py-20 t-text-muted animate-fade-in"},Cn={key:1,class:"animate-fade-in"},Ln={class:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6"},In={class:"flex items-center gap-3 mb-1"},Mn={class:"text-2xl font-bold t-heading"},jn={class:"glass-panel rounded-xl p-4 mb-6 flex flex-wrap gap-4 items-center"},Rn={class:"flex items-center gap-2"},On=["value"],An={class:"flex items-center gap-2"},Fn=["value"],Bn={key:0,class:"flex items-center gap-2"},Hn=["value"],Pn={key:1,class:"max-w-3xl mx-auto"},En={key:0,class:"space-y-0"},Nn=["onDragstart","onDragover","onDrop"],zn=["data-seg-idx"],qn={class:"mt-6 text-center"},Kn={__name:"PlanDetailView",setup(n){const b=Jt(),l=Kt(),s=lt(),o=Gt(),{dragIndex:u,dragOverIndex:w,onDragStart:_,onDragOver:p,onDragLeave:r,onDrop:y,onDragEnd:x}=ee({enabled:!1}),c=T(!0),$=T(!1),m=T(null),v=T("add"),g=T(!1),i=T(!1),C=T(null),I=T(-1),F=T(!1),K=T(null),vt=T(-1),U=T(null);let Q=null;const A=h(()=>s.activePlan),z=h(()=>{var a;return((a=A.value)==null?void 0:a.days)||[]}),mt=h(()=>s.activeDetailTab==="overview"),B=h(()=>s.getCurrentDayIndex()),V=h(()=>z.value[B.value]||null),j=h(()=>{var a;return((a=V.value)==null?void 0:a.segments)||[]}),q=h(()=>V.value?(et(V.value),Qt(V.value)):[]),Tt=h(()=>j.value.length>0||s.tempStartLocation);dt(async()=>{var a,e,L;try{const O=b.params.id;if(((a=s.activePlan)==null?void 0:a.id)!==O){const H=await Yt(O);s.activePlan=H}s.activeDetailTab=0,(L=(e=A.value)==null?void 0:e.days)==null||L.forEach(H=>et(H)),s.syncTempStartLocationForCurrentDay()}catch{o.showToast("加载行程失败","error"),l.push({name:"plans"})}finally{c.value=!1}}),ct(()=>{Q&&clearTimeout(Q)}),kt(()=>s.activeDetailTab,()=>{var a,e;(e=(a=A.value)==null?void 0:a.days)!=null&&e.length&&s.syncTempStartLocationForCurrentDay()},{immediate:!1}),kt(()=>A.value,()=>{!A.value||c.value||(Q&&clearTimeout(Q),Q=setTimeout(()=>s.saveActivePlanSilently(),2e3))},{deep:!0});function St(a){s.updatePlanDepartureDate(a.target.value)}function Ct(a){const e=parseInt(a.target.value,10)||1;s.updatePlanDaysCount(e)}function Lt(a){V.value&&(V.value.start_time_hm=a.target.value||"08:00")}function rt(a,e,L){const O=z.value[a];O&&(et(O),O.location_stay_minutes[e]!==void 0&&(O.location_stay_minutes[e]=L))}function Y(a=null){v.value="add",m.value=a,$.value=!0}function ft(){v.value="replaceStart",m.value=null,$.value=!0}async function It(a){var L;$.value=!1;const e=B.value;!a.city&&((L=A.value.start_location)!=null&&L.city)&&(a.city=A.value.start_location.city),s.setDayStartLocation(e,a),s.tempStartLocation={...a},o.showToast("当日起点已更新")}async function Mt(a){if(v.value==="replaceStart"){await It(a),v.value="add";return}await jt(a)}async function jt(a){var H;$.value=!1;const e=B.value,L=z.value[e].segments;if(!a.city&&((H=A.value.start_location)!=null&&H.city)&&(a.city=A.value.start_location.city),L.length===0&&!s.tempStartLocation){s.tempStartLocation=a,e===0&&(A.value.start_location={name:a.name,lat:a.lat,lng:a.lng,address:a.address,city:a.city}),o.showToast("起点设置成功");return}if(L.length===0&&s.tempStartLocation){await s.addSegment(s.tempStartLocation,a),s.tempStartLocation=null,o.showToast("地点已添加");return}if(m.value!==null){await s.insertSegmentAt(m.value,a),o.showToast("地点已插入");return}const O=L[L.length-1].destination;await s.addSegment(O,a),o.showToast("地点已添加")}async function it(a,e){confirm("确定要删除这个地点吗？")&&(await s.removeLocation(a,e),o.showToast("地点已删除"))}function Rt(a){I.value=a,C.value=j.value[a],i.value=!0}function Ot(){i.value=!1,I.value>=0&&At(I.value)}function At(a){const e=document.querySelector(`[data-seg-idx="${a}"]`),L=(e==null?void 0:e.getBoundingClientRect())||{top:200,left:200,bottom:240,right:300};K.value=L,vt.value=a,F.value=!0}async function Ft(a){const e=vt.value;if(F.value=!1,!(e<0)){if(a==="flight"){U.value=e,g.value=!0;return}try{await s.changeTransportMode(e,a),o.showToast("交通方式已更新")}catch{o.showToast("切换交通方式失败","error")}}}function Bt(){U.value=null,$.value=!1,g.value=!0}function Ht(){g.value=!1,U.value=null}async function Pt(a){if(U.value!==null){s.replaceSegmentWithTicketData(U.value,a),U.value=null,g.value=!1,o.showToast("已更新为航班");return}g.value=!1;const e=B.value,L=z.value[e].segments,O={name:a.departure_station||a.departure_city||"出发地",city:a.departure_city||"",departure_time:a.departure_time},H={name:a.arrival_station||a.arrival_city||"目的地",city:a.arrival_city||"",arrival_time:a.arrival_time},Z=a.duration_seconds?Math.round(a.duration_seconds/60):0,tt={type:a.type||"train",origin:O,destination:H,distance_km:a.distance_km||0,duration_minutes:Z,details:{flight_no:a.flight_no,train_no:a.train_no,departure_time:a.departure_time,arrival_time:a.arrival_time,seat_info:a.seat_info}};L.push(tt),et(z.value[e]),o.showToast("票据已导入"),s.saveActivePlanSilently()}async function Et(){try{await s.saveActivePlan(),o.showToast("行程已保存")}catch{o.showToast("保存失败","error")}}async function Nt(){if(confirm("确定要删除整个行程吗？此操作不可恢复。"))try{await Zt(A.value.id),o.showToast("行程已删除"),l.push({name:"plans"})}catch{o.showToast("删除失败","error")}}return(a,e)=>{var L,O,H,Z,tt,pt,yt,xt,gt;return d(),f("div",Tn,[c.value?(d(),f("div",Sn,[...e[12]||(e[12]=[t("i",{class:"fas fa-spinner fa-spin text-4xl text-cyan-500 mb-4"},null,-1),t("p",{class:"text-lg"},"加载行程...",-1)])])):A.value?(d(),f("div",Cn,[t("div",Ln,[t("div",null,[t("div",In,[t("button",{onClick:e[0]||(e[0]=M=>D(l).push({name:"plans"})),class:"t-text-muted hover:text-cyan-500 transition"},[...e[13]||(e[13]=[t("i",{class:"fas fa-arrow-left mr-1"},null,-1),P(" 返回 ",-1)])])]),t("h1",Mn,k(A.value.title||"未命名行程"),1)]),t("div",{class:"flex items-center gap-2 flex-wrap"},[t("button",{onClick:Et,class:"px-4 py-2 bg-gradient-to-r from-cyan-600 to-blue-600 text-white rounded-lg hover:shadow-lg transition flex items-center gap-2 font-medium text-sm"},[...e[14]||(e[14]=[t("i",{class:"fas fa-save"},null,-1),P(" 保存 ",-1)])]),t("button",{onClick:Nt,class:"px-4 py-2 rounded-lg border transition t-text-sub hover:text-red-500 hover:border-red-400 text-sm",style:{"border-color":"var(--border-color)"}},[...e[15]||(e[15]=[t("i",{class:"fas fa-trash-alt mr-1"},null,-1),P(" 删除 ",-1)])])])]),t("div",jn,[t("div",Rn,[e[16]||(e[16]=t("i",{class:"far fa-calendar-alt text-cyan-500"},null,-1)),e[17]||(e[17]=t("label",{class:"text-xs t-text-muted font-medium"},"出发日期",-1)),t("input",{type:"date",value:((L=z.value[0])==null?void 0:L.date)||"",class:"rounded-lg px-3 py-1.5 text-sm border outline-none",onChange:St},null,40,On)]),t("div",An,[e[18]||(e[18]=t("i",{class:"fas fa-hashtag text-cyan-500"},null,-1)),e[19]||(e[19]=t("label",{class:"text-xs t-text-muted font-medium"},"天数",-1)),t("input",{type:"number",value:z.value.length,min:"1",max:"30",class:"w-16 rounded-lg px-3 py-1.5 text-sm border outline-none text-center",onChange:Ct},null,40,Fn)]),mt.value?S("",!0):(d(),f("div",Bn,[e[20]||(e[20]=t("i",{class:"far fa-clock text-cyan-500"},null,-1)),e[21]||(e[21]=t("label",{class:"text-xs t-text-muted font-medium"},"当日出发时间",-1)),t("input",{type:"time",value:((O=V.value)==null?void 0:O.start_time_hm)||"08:00",class:"rounded-lg px-3 py-1.5 text-sm border outline-none",onChange:Lt},null,40,Hn)]))]),G(le,{days:z.value},null,8,["days"]),mt.value?(d(),W(ve,{key:0,days:z.value},null,8,["days"])):(d(),f("div",Pn,[Tt.value?(d(),f("div",En,[j.value.length===0&&D(s).tempStartLocation?(d(),W(ut,{key:0,location:D(s).tempStartLocation,index:0,"is-last":!0,"role-label":(B.value===0,"起点"),"arrival-hm":((H=q.value[0])==null?void 0:H.arrivalHm)||"--","stay-minutes":((Z=q.value[0])==null?void 0:Z.stayMinutes)||0,"departure-hm":(tt=q.value[0])==null?void 0:tt.departureHm,"day-index":B.value,"can-edit-start":!0,onInsert:Y,onEditStart:ft,onRemove:it,onUpdateStay:rt},null,8,["location","role-label","arrival-hm","stay-minutes","departure-hm","day-index"])):S("",!0),(d(!0),f(J,null,X(j.value,(M,R)=>{var bt,ht,wt;return d(),f(J,{key:R},[t("div",{draggable:"false",onDragstart:E=>D(_)(E,R),onDragover:E=>D(p)(E,R),onDragleave:e[1]||(e[1]=(...E)=>D(r)&&D(r)(...E)),onDrop:E=>D(y)(E,R,B.value),onDragend:e[2]||(e[2]=(...E)=>D(x)&&D(x)(...E)),class:N({"opacity-50":D(u)===R,"ring-2 ring-cyan-400 rounded-xl":D(w)===R})},[G(ut,{location:M.origin,index:R,"is-last":!1,"role-label":R===0&&B.value===0||R===0?"起点":null,"arrival-hm":((bt=q.value[R])==null?void 0:bt.arrivalHm)||"--","stay-minutes":((ht=q.value[R])==null?void 0:ht.stayMinutes)||0,"departure-hm":(wt=q.value[R])==null?void 0:wt.departureHm,"day-index":B.value,"can-edit-start":R===0,onInsert:Y,onEditStart:ft,onRemove:it,onUpdateStay:rt},null,8,["location","index","role-label","arrival-hm","stay-minutes","departure-hm","day-index","can-edit-start"])],42,Nn),t("div",{"data-seg-idx":R},[G(He,{segment:M,index:R,onOpenDetail:E=>Rt(R)},null,8,["segment","index","onOpenDetail"])],8,zn)],64)}),128)),j.value.length>0?(d(),f("div",{key:1,draggable:"false",onDragstart:e[3]||(e[3]=M=>D(_)(M,j.value.length)),onDragover:e[4]||(e[4]=M=>D(p)(M,j.value.length)),onDragleave:e[5]||(e[5]=(...M)=>D(r)&&D(r)(...M)),onDrop:e[6]||(e[6]=M=>D(y)(M,j.value.length,B.value)),onDragend:e[7]||(e[7]=(...M)=>D(x)&&D(x)(...M)),class:N({"opacity-50":D(u)===j.value.length,"ring-2 ring-cyan-400 rounded-xl":D(w)===j.value.length})},[G(ut,{location:j.value[j.value.length-1].destination,index:j.value.length,"is-last":!0,"role-label":"终点","arrival-hm":((pt=q.value[j.value.length])==null?void 0:pt.arrivalHm)||"--","stay-minutes":((yt=q.value[j.value.length])==null?void 0:yt.stayMinutes)||0,"departure-hm":(xt=q.value[j.value.length])==null?void 0:xt.departureHm,"day-index":B.value,onInsert:Y,onRemove:it,onUpdateStay:rt},null,8,["location","index","arrival-hm","stay-minutes","departure-hm","day-index"])],34)):S("",!0)])):S("",!0),t("div",qn,[t("button",{type:"button",onClick:e[8]||(e[8]=M=>Y(null)),class:"px-6 py-3 border-2 border-dashed border-cyan-400/50 rounded-xl text-cyan-500 hover:bg-cyan-500/10 hover:border-cyan-400 transition flex items-center gap-2 mx-auto"},[...e[22]||(e[22]=[t("i",{class:"fas fa-plus"},null,-1),P(" 添加下一站目的地 ",-1)])])])]))])):S("",!0),G(pn,{show:$.value,title:v.value==="replaceStart"?"修改当日起点":"添加行程地点",city:((gt=V.value)==null?void 0:gt.city)||"","insert-at-index":m.value,onClose:e[9]||(e[9]=M=>$.value=!1),onSelect:Mt,onOpenTicketImport:Bt},null,8,["show","title","city","insert-at-index"]),G(Dn,{show:g.value,title:U.value!==null?"上传机票截图":"导入航班 / 车票","expect-flight-only":U.value!==null,onClose:Ht,onImported:Pt},null,8,["show","title","expect-flight-only"]),G(Ze,{show:i.value,segment:C.value,onClose:e[10]||(e[10]=M=>i.value=!1),onChange:Ot},null,8,["show","segment"]),F.value?(d(),W(Ne,{key:2,show:F.value,"trigger-rect":K.value,onSelect:Ft,onClose:e[11]||(e[11]=M=>F.value=!1)},null,8,["show","trigger-rect"])):S("",!0)])}}};export{Kn as default};
