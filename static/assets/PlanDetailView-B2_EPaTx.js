import{f as T,a as d,c as f,b as t,m as nt,u as _,n as P,F as J,r as X,t as w,h as S,l as at,p as g,o as dt,q as zt,s as ct,k as W,T as st,e as E,x as qt,y as Ut,w as Vt,v as Wt,i as Gt,z as kt,A as G,B as Jt,g as Kt}from"./index-CxELTe30.js";import{u as lt,f as $t,d as _t,e as et,g as Qt}from"./plan-hNf8-T6S.js";import{p as Xt,a as Yt,d as Zt}from"./plans-CWatqful.js";import{s as te}from"./locations-CCAFugoJ.js";import"./client-Be4OVhjz.js";function ee(){const a=lt(),y=T(null),e=T(null);function l(c,r){y.value=r,c.dataTransfer.effectAllowed="move",c.dataTransfer.setData("text/plain",String(r))}function o(c,r){c.preventDefault(),c.dataTransfer.dropEffect="move",e.value=r}function u(){e.value=null}async function h(c,r,$){c.preventDefault();const b=y.value;if(e.value=null,b===null||b===r){y.value=null;return}await a.reorderLocations($,b,r),y.value=null}function k(){y.value=null,e.value=null}return{dragIndex:y,dragOverIndex:e,onDragStart:l,onDragOver:o,onDragLeave:u,onDrop:h,onDragEnd:k}}const ne={class:"mb-4",style:{"border-bottom":"1px solid var(--border-color)"}},ae={class:"flex gap-2 overflow-x-auto py-2 -mx-1 px-1 min-h-[44px] items-center"},se=["onClick"],le={__name:"DayTabs",props:{days:{type:Array,required:!0}},setup(a){const y=lt();return(e,l)=>(d(),f("div",ne,[t("div",ae,[t("button",{type:"button",onClick:l[0]||(l[0]=o=>_(y).activeDetailTab="overview"),class:P(["flex-shrink-0 px-4 py-2 rounded-full text-sm font-medium transition whitespace-nowrap",_(y).activeDetailTab==="overview"?"bg-cyan-600 text-white shadow-lg shadow-cyan-500/20":"t-text-sub"]),style:nt(_(y).activeDetailTab!=="overview"?"background: var(--bg-card); border: 1px solid var(--border-color);":"")}," 总览 ",6),(d(!0),f(J,null,X(a.days,(o,u)=>(d(),f("button",{key:u,type:"button",onClick:h=>_(y).activeDetailTab=u,class:P(["flex-shrink-0 px-4 py-2 rounded-full text-sm font-medium transition whitespace-nowrap",_(y).activeDetailTab===u?"bg-cyan-600 text-white shadow-lg shadow-cyan-500/20":"t-text-sub"]),style:nt(_(y).activeDetailTab!==u?"background: var(--bg-card); border: 1px solid var(--border-color);":"")}," 第 "+w(u+1)+" 天 ",15,se))),128))])]))}},oe={class:"space-y-4"},re=["onClick"],ie={class:"flex justify-between items-center"},ue={class:"font-bold t-text group-hover:text-cyan-500 transition"},de={class:"text-sm t-text-muted"},ce={class:"text-sm t-text-sub mt-1"},ve={__name:"DayOverview",props:{days:{type:Array,required:!0}},setup(a){const y=lt();return(e,l)=>(d(),f("div",oe,[(d(!0),f(J,null,X(a.days,(o,u)=>(d(),f("div",{key:u,onClick:h=>_(y).activeDetailTab=u,class:"rounded-xl p-4 cursor-pointer transition group",style:{background:"var(--bg-card)",border:"1px solid var(--border-color)"}},[t("div",ie,[t("span",ue,"第 "+w(u+1)+" 天",1),t("span",de,w(o.date?new Date(o.date).toLocaleDateString("zh-CN",{month:"long",day:"numeric"}):`第 ${u+1} 天`),1)]),t("p",ce,w((o.segments||[]).length>0?o.segments.length+1:0)+" 个地点",1)],8,re))),128))]))}},me={class:"timeline-item group relative"},pe={class:"timeline-rail"},fe={class:"text-sm font-bold font-mono"},ye={class:"timeline-time"},xe={key:0,class:"timeline-line"},ge={class:"flex-1 min-w-0 pb-2"},be={class:"flex justify-between items-start gap-3"},he={class:"min-w-0 flex-1"},we={class:"flex items-center flex-wrap gap-2 mb-1.5"},ke={class:"font-bold t-heading text-lg leading-snug"},$e={key:0,class:"px-2 py-0.5 rounded-full text-xs font-bold shadow-sm",style:{background:"var(--badge-start-bg)",color:"var(--badge-start-text)"}},_e={key:1,class:"px-2 py-0.5 rounded-full text-xs font-bold shadow-sm",style:{background:"var(--badge-end-bg)",color:"var(--badge-end-text)"}},De={class:"text-sm t-text-sub flex items-center gap-1.5 mb-3"},Te={class:"truncate opacity-80"},Se={class:"flex items-center gap-4 flex-wrap"},Ce={class:"inline-flex items-center gap-2 rounded-lg px-2.5 py-1",style:{background:"var(--bg-inset)",border:"1px solid var(--border-subtle)"}},Le={class:"text-xs t-text-sub font-medium"},Ie=["value"],ut={__name:"LocationCard",props:{location:{type:Object,default:null},index:{type:Number,required:!0},isLast:{type:Boolean,default:!1},roleLabel:{type:String,default:null},arrivalHm:{type:String,default:"--"},stayMinutes:{type:Number,default:0},dayIndex:{type:Number,default:0},departureHm:{type:String,default:null},canEditStart:{type:Boolean,default:!1}},emits:["insert","remove","updateStay","editStart"],setup(a,{emit:y}){const e=a,l=y,o=g(()=>{var c;return(c=e.location)!=null&&c.name?e.location.name:e.roleLabel==="起点"?"起点（待补充）":e.roleLabel==="终点"?"终点（待补充）":"未知地点"}),u=g(()=>{var c,r,$;return((c=e.location)==null?void 0:c.address)||((r=e.location)==null?void 0:r.city)||(($=e.location)==null?void 0:$.name)||"未知地址"}),h=g(()=>e.departureHm&&e.stayMinutes>0?`到达 ${e.arrivalHm} · 离开 ${e.departureHm}`:`到达 ${e.arrivalHm}`);function k(c){const r=Math.max(0,Math.min(480,parseInt(c.target.value,10)||0));l("updateStay",e.dayIndex,e.index,r)}return(c,r)=>(d(),f("div",me,[t("div",pe,[t("div",{class:P(["timeline-node",{"bg-emerald-500 border-emerald-300 text-white shadow-emerald-500/30":a.roleLabel==="起点","bg-rose-500 border-rose-300 text-white shadow-rose-500/30":a.isLast&&a.roleLabel==="终点"}])},[t("span",fe,w(a.index+1),1)],2),t("div",ye,w(a.arrivalHm),1),a.isLast?S("",!0):(d(),f("div",xe))]),t("div",ge,[t("div",{class:P(["location-card",{"is-start":a.roleLabel==="起点","is-end":a.roleLabel==="终点"}])},[t("div",be,[t("div",he,[t("div",we,[t("h4",ke,w(o.value),1),a.roleLabel==="起点"?(d(),f("span",$e,"起点")):S("",!0),a.roleLabel==="终点"?(d(),f("span",_e,"终点")):S("",!0)]),t("p",De,[r[5]||(r[5]=t("i",{class:"fas fa-map-marker-alt text-cyan-500/70 text-xs"},null,-1)),t("span",Te,w(u.value),1)]),t("div",Se,[t("div",Ce,[r[6]||(r[6]=t("i",{class:"far fa-clock t-text-muted text-xs"},null,-1)),t("span",Le,w(h.value),1)]),t("div",{class:"inline-flex items-center gap-1.5",onClick:r[0]||(r[0]=at(()=>{},["stop"]))},[r[7]||(r[7]=t("i",{class:"fas fa-hourglass-half t-text-muted text-xs"},null,-1)),r[8]||(r[8]=t("span",{class:"text-xs t-text-muted"},"停留",-1)),t("input",{type:"number",min:"0",max:"480",step:"15",value:a.stayMinutes,class:"w-14 text-xs text-center border-0 bg-transparent py-0.5 focus:ring-0 font-medium transition-colors",style:{"border-bottom":"1px solid var(--border-color)",color:"var(--text-primary)"},onChange:k},null,40,Ie),r[9]||(r[9]=t("span",{class:"text-xs t-text-muted"},"分",-1))])])]),t("div",{class:"flex flex-col gap-1 flex-shrink-0 opacity-0 group-hover:opacity-100 transition-opacity duration-200",onClick:r[4]||(r[4]=at(()=>{},["stop"]))},[a.canEditStart?(d(),f("button",{key:0,type:"button",class:"w-8 h-8 flex items-center justify-center rounded-lg text-amber-600 hover:bg-amber-500 hover:text-white transition shadow-sm",style:{background:"var(--nav-active-bg)"},onClick:r[1]||(r[1]=$=>l("editStart")),title:"修改起点"},[...r[10]||(r[10]=[t("i",{class:"fas fa-edit text-xs"},null,-1)])])):S("",!0),t("button",{type:"button",class:"w-8 h-8 flex items-center justify-center rounded-lg text-cyan-600 hover:bg-cyan-500 hover:text-white transition shadow-sm",style:{background:"var(--nav-active-bg)"},onClick:r[2]||(r[2]=$=>l("insert",a.isLast?null:a.index+1)),title:"在此处插入下一站"},[...r[11]||(r[11]=[t("i",{class:"fas fa-plus text-xs"},null,-1)])]),t("button",{type:"button",class:"w-8 h-8 flex items-center justify-center rounded-lg t-text-muted hover:bg-rose-500/10 hover:text-rose-500 transition shadow-sm",style:{background:"var(--bg-inset)"},onClick:r[3]||(r[3]=$=>l("remove",a.index,a.isLast)),title:"删除此地点"},[...r[12]||(r[12]=[t("i",{class:"fas fa-trash-alt text-xs"},null,-1)])])])])],2)])]))}},Me={driving:"fa-car",transit:"fa-bus",walking:"fa-walking",cycling:"fa-bicycle",flight:"fa-plane",train:"fa-train"};function ot(a){var o,u,h,k,c,r;if(!a)return"driving";if(a.type==="flight"||a.type==="train")return a.type;const y=((o=a.details)==null?void 0:o.departure_time)||((u=a.origin)==null?void 0:u.departure_time),e=((h=a.details)==null?void 0:h.arrival_time)||((k=a.destination)==null?void 0:k.arrival_time);if(!y||!e)return a.type;const l=(((c=a.origin)==null?void 0:c.name)||"")+(((r=a.destination)==null?void 0:r.name)||"");return/机场|航空|航班/i.test(l)?"flight":/站|火车站|高铁|动车|列车/i.test(l)?"train":a.type}function Dt(a){const y=typeof a=="string"?a:ot(a);return Me[y]||"fa-car"}function je(a){var l,o,u;if(!a)return"驾车";const y=ot(a);return{driving:"驾车",transit:((l=a.details)==null?void 0:l.display_label)==="城际交通"?"城际交通":"公交",walking:"步行",cycling:"骑行",flight:((o=a.details)==null?void 0:o.flight_no)||"航班",train:((u=a.details)==null?void 0:u.train_no)||"高铁"}[y]||"驾车"}const Re={class:"transport-connector-row"},Oe={class:"flex-1 min-w-0 py-1"},Ae={class:"font-semibold"},Fe={class:"font-mono text-[11px] opacity-80"},Be={class:"font-mono text-[11px] opacity-60 ml-0.5"},He={__name:"TransportConnector",props:{segment:{type:Object,required:!0},index:{type:Number,required:!0}},emits:["openDetail"],setup(a,{emit:y}){const e=a,l=y,o=g(()=>Dt(e.segment)),u=g(()=>je(e.segment)),h=g(()=>ot(e.segment)),k=g(()=>h.value==="flight"||h.value==="train"),c=g(()=>{var p,v;return((p=e.segment.details)==null?void 0:p.departure_time)||((v=e.segment.origin)==null?void 0:v.departure_time)}),r=g(()=>{var p,v;return((p=e.segment.details)==null?void 0:p.arrival_time)||((v=e.segment.destination)==null?void 0:v.arrival_time)}),$=g(()=>c.value&&r.value?`${c.value} → ${r.value}`:c.value||r.value||""),b=g(()=>{if(c.value&&r.value){const p=_t(c.value,r.value);if(p>0)return p}return e.segment.duration_minutes!=null?e.segment.duration_minutes*60:null}),m=g(()=>k.value&&$.value?$.value:b.value!=null?$t(b.value):"--"),D=g(()=>e.segment.distance_km!=null&&e.segment.distance_km>0?`${e.segment.distance_km}km`:k.value?"—":"--");return(p,v)=>(d(),f("div",Re,[v[3]||(v[3]=t("div",{class:"timeline-rail-spacer"},[t("div",{class:"timeline-line-through"})],-1)),t("div",Oe,[t("div",{onClick:v[0]||(v[0]=x=>l("openDetail",a.index)),class:"transport-badge group/conn",title:"点击查看详情"},[t("i",{class:P(["fas",o.value,"text-xs"])},null,2),t("span",Ae,w(u.value),1),v[1]||(v[1]=t("span",{class:"transport-badge-divider"},null,-1)),t("span",Fe,w(m.value),1),t("span",Be,"("+w(D.value)+")",1),v[2]||(v[2]=t("i",{class:"fas fa-chevron-right text-[10px] opacity-40 ml-1 group-hover/conn:opacity-100 transition-opacity"},null,-1))])])]))}},Ee=["onClick"],Ne={class:"text-sm font-medium"},Pe={__name:"TransportDropdown",props:{show:Boolean,triggerRect:{type:Object,default:null}},emits:["select","close"],setup(a,{emit:y}){const e=a,l=y,o=T(null),u=T({}),h=[{mode:"driving",icon:"fa-car",label:"驾车"},{mode:"transit",icon:"fa-bus",label:"公交/地铁"},{mode:"train",icon:"fa-train",label:"高铁/火车"},{mode:"flight",icon:"fa-plane",label:"飞机"},{mode:"walking",icon:"fa-walking",label:"步行"},{mode:"cycling",icon:"fa-bicycle",label:"骑行"}];function k(){if(!e.triggerRect)return;const $=e.triggerRect;let b=$.bottom+8;const m=Math.min($.left,window.innerWidth-170);b+220>window.innerHeight&&(b=$.top-220-8),u.value={top:`${b}px`,left:`${m}px`}}function c($){o.value&&!o.value.contains($.target)&&l("close")}dt(()=>{k(),zt(()=>document.addEventListener("click",c))}),ct(()=>{document.removeEventListener("click",c)});function r($){l("select",$),l("close")}return($,b)=>(d(),W(st,{to:"body"},[a.show?(d(),f("div",{key:0,ref_key:"dropdownRef",ref:o,class:"fixed z-[100] rounded-xl shadow-2xl py-1.5 w-40 animate-fade-in",style:nt({...u.value,background:"var(--dropdown-bg)",border:"1px solid var(--dropdown-border)"})},[(d(),f(J,null,X(h,m=>t("button",{key:m.mode,onClick:D=>r(m.mode),class:"w-full text-left px-4 py-2.5 transition flex items-center gap-3 group",style:{color:"var(--dropdown-text)"}},[t("i",{class:P(["fas",m.icon,"w-5 text-center"]),style:{color:"var(--dropdown-icon)"}},null,2),t("span",Ne,w(m.label),1)],8,Ee)),64))],4)):S("",!0)]))}},ze={key:0,class:"fixed inset-0 z-[61]"},qe={class:"flex justify-between items-center mb-4"},Ue={class:"t-text-sub text-sm space-y-3 mb-6"},Ve={class:"py-1.5",style:{"border-bottom":"1px solid var(--border-subtle)"}},We={class:"flex items-center gap-2 font-medium",style:{color:"var(--text-primary)"}},Ge={class:"py-1.5 flex justify-between",style:{"border-bottom":"1px solid var(--border-subtle)"}},Je={class:"py-1.5 flex justify-between",style:{"border-bottom":"1px solid var(--border-subtle)"}},Ke={key:0,class:"py-1.5 flex justify-between",style:{"border-bottom":"1px solid var(--border-subtle)"}},Qe={key:1,class:"py-1.5 flex justify-between",style:{"border-bottom":"1px solid var(--border-subtle)"}},Xe={class:"py-1.5 flex justify-between",style:{"border-bottom":"1px solid var(--border-subtle)"}},Ye={class:"py-1.5 flex justify-between"},Ze={__name:"TransportDetailModal",props:{show:Boolean,segment:{type:Object,default:null}},emits:["close","change"],setup(a,{emit:y}){const e=a,l=y,o=g(()=>ot(e.segment)),u=g(()=>Dt(e.segment)),h=g(()=>{var C,I,F;if(!e.segment)return"驾车";const x=e.segment;return{driving:"驾车",transit:((C=x.details)==null?void 0:C.display_label)==="城际交通"?"城际交通":"公交/地铁",walking:"步行",cycling:"骑行",flight:((I=x.details)==null?void 0:I.flight_no)||"航班",train:((F=x.details)==null?void 0:F.train_no)||"高铁/火车"}[o.value]||"驾车"}),k=g(()=>{var x,i,C,I;return((i=(x=e.segment)==null?void 0:x.details)==null?void 0:i.departure_time)||((I=(C=e.segment)==null?void 0:C.origin)==null?void 0:I.departure_time)}),c=g(()=>{var x,i,C,I;return((i=(x=e.segment)==null?void 0:x.details)==null?void 0:i.arrival_time)||((I=(C=e.segment)==null?void 0:C.destination)==null?void 0:I.arrival_time)}),r=g(()=>{var x;if(k.value&&c.value){const i=_t(k.value,c.value);if(i>0)return i}return((x=e.segment)==null?void 0:x.duration_minutes)!=null?e.segment.duration_minutes*60:null}),$=g(()=>r.value!=null?$t(r.value):"--"),b=g(()=>{var x;return((x=e.segment)==null?void 0:x.distance_km)!=null&&e.segment.distance_km>0?`${e.segment.distance_km} km`:o.value==="flight"||o.value==="train"?"—":"--"}),m=g(()=>{var x,i;return((i=(x=e.segment)==null?void 0:x.origin)==null?void 0:i.name)||"起点"}),D=g(()=>{var x,i;return((i=(x=e.segment)==null?void 0:x.destination)==null?void 0:i.name)||"终点"}),p=g(()=>o.value==="flight"||o.value==="train"),v=g(()=>{var x,i,C,I,F,K;return((x=e.segment)==null?void 0:x.type)==="flight"&&((C=(i=e.segment)==null?void 0:i.details)==null?void 0:C.flight_no)||((I=e.segment)==null?void 0:I.type)==="train"&&((K=(F=e.segment)==null?void 0:F.details)==null?void 0:K.train_no)});return(x,i)=>{var C;return d(),W(st,{to:"body"},[a.show&&a.segment?(d(),f("div",ze,[t("div",{class:"absolute inset-0 backdrop-blur-sm",style:{background:"var(--modal-overlay)"},onClick:i[0]||(i[0]=I=>l("close"))}),t("div",{class:"absolute bottom-0 left-0 right-0 md:top-1/2 md:left-1/2 md:bottom-auto md:-translate-x-1/2 md:-translate-y-1/2 md:w-[400px] max-h-[90vh] overflow-y-auto md:rounded-2xl rounded-t-2xl shadow-2xl p-6",style:{background:"var(--modal-bg)"},onClick:i[3]||(i[3]=at(()=>{},["stop"]))},[t("div",qe,[i[5]||(i[5]=t("h3",{class:"text-lg font-bold t-heading"},"交通方式详情",-1)),t("button",{type:"button",onClick:i[1]||(i[1]=I=>l("close")),class:"w-8 h-8 flex items-center justify-center rounded-full t-text-sub transition",style:{background:"var(--bg-inset)"}},[...i[4]||(i[4]=[t("i",{class:"fas fa-times"},null,-1)])])]),t("div",Ue,[t("div",Ve,[t("div",We,[t("i",{class:P(["fas",u.value,"text-cyan-600"])},null,2),E(" "+w(h.value),1)])]),t("div",Ge,[i[6]||(i[6]=t("span",{class:"t-text-muted"},"起点",-1)),t("span",null,w(m.value),1)]),t("div",Je,[i[7]||(i[7]=t("span",{class:"t-text-muted"},"终点",-1)),t("span",null,w(D.value),1)]),p.value&&(k.value||c.value)?(d(),f("div",Ke,[i[8]||(i[8]=t("span",{class:"t-text-muted"},"时间",-1)),t("span",null,w(k.value||"--")+" → "+w(c.value||"--"),1)])):S("",!0),p.value&&((C=a.segment.details)!=null&&C.seat_info)?(d(),f("div",Qe,[i[9]||(i[9]=t("span",{class:"t-text-muted"},"座位",-1)),t("span",null,w(a.segment.details.seat_info),1)])):S("",!0),t("div",Xe,[i[10]||(i[10]=t("span",{class:"t-text-muted"},"时长",-1)),t("span",null,w($.value),1)]),t("div",Ye,[i[11]||(i[11]=t("span",{class:"t-text-muted"},"距离",-1)),t("span",null,w(b.value),1)])]),v.value?S("",!0):(d(),f("button",{key:0,type:"button",class:"w-full py-3 rounded-xl border-2 border-cyan-500 text-cyan-600 font-medium transition",onClick:i[2]||(i[2]=I=>l("change"))},[...i[12]||(i[12]=[t("i",{class:"fas fa-exchange-alt mr-2"},null,-1),E(" 更改交通方式 ",-1)])]))])])):S("",!0)])}}},tn={key:0,class:"fixed inset-0 z-[60] flex items-center justify-center"},en={class:"flex justify-between items-center mb-6"},nn={class:"text-lg font-bold t-heading"},an={__name:"BaseModal",props:{show:Boolean,title:{type:String,default:""},maxWidth:{type:String,default:"500px"}},emits:["close"],setup(a,{emit:y}){const e=y;return(l,o)=>(d(),W(st,{to:"body"},[a.show?(d(),f("div",tn,[t("div",{class:"absolute inset-0 backdrop-blur-sm transition-opacity",style:{background:"var(--modal-overlay)"},onClick:o[0]||(o[0]=u=>e("close"))}),t("div",{class:"relative w-[calc(100%-2rem)] rounded-2xl shadow-2xl p-6 animate-fade-in",style:nt({maxWidth:a.maxWidth,background:"var(--modal-bg)"})},[t("div",en,[t("h3",nn,w(a.title),1),t("button",{onClick:o[1]||(o[1]=u=>e("close")),class:"w-8 h-8 flex items-center justify-center rounded-full t-text-sub transition",style:{background:"var(--bg-inset)"}},[...o[2]||(o[2]=[t("i",{class:"fas fa-times"},null,-1)])])]),qt(l.$slots,"default")],4)])):S("",!0)]))}},sn={class:"relative mb-4"},ln={class:"flex gap-2 mb-4 overflow-x-auto pb-2"},on={class:"h-64 overflow-y-auto space-y-2"},rn={key:0,class:"text-center py-4 t-text-muted"},un={key:1,class:"text-center t-text-muted py-10"},dn={key:0,class:"text-xs mt-1 text-cyan-600"},cn={key:2,class:"text-center py-4 t-text-muted"},vn=["onClick"],mn={class:"font-medium text-sm t-text"},pn={class:"text-xs t-text-muted truncate w-64"},fn={__name:"AddLocationModal",props:{show:Boolean,title:{type:String,default:"添加行程地点"},city:{type:String,default:""},insertAtIndex:{type:[Number,null],default:null}},emits:["close","select","openTicketImport"],setup(a,{emit:y}){const e=a,l=y,o=T(""),u=T([]),h=T(!1);let k=null;function c(b){k&&clearTimeout(k),b.trim()&&(k=setTimeout(async()=>{h.value=!0;try{u.value=await te(b,e.city)}catch(m){console.error(m)}finally{h.value=!1}},500))}function r(b){l("select",{name:b.name,address:b.address,city:b.city||e.city||"",lat:b.location?parseFloat(b.location.split(",")[1]):null,lng:b.location?parseFloat(b.location.split(",")[0]):null})}function $(){o.value="",u.value=[],l("close")}return(b,m)=>(d(),W(an,{show:a.show,title:a.title,onClose:$},{default:Ut(()=>[t("div",sn,[m[3]||(m[3]=t("i",{class:"fas fa-search absolute left-4 top-1/2 -translate-y-1/2 t-text-muted"},null,-1)),Vt(t("input",{"onUpdate:modelValue":m[0]||(m[0]=D=>o.value=D),type:"text",placeholder:"搜索地点...",class:"w-full pl-11 pr-4 py-3 rounded-xl border outline-none transition",onInput:m[1]||(m[1]=D=>c(o.value))},null,544),[[Wt,o.value]])]),t("div",ln,[m[5]||(m[5]=t("button",{class:"flex-shrink-0 px-3 py-1.5 text-cyan-600 text-xs rounded-lg font-medium flex items-center gap-1",style:{background:"var(--nav-active-bg)",border:"1px solid rgba(6,182,212,0.2)"}},[t("i",{class:"fas fa-search"}),E(" 搜索 ")],-1)),t("button",{type:"button",onClick:m[2]||(m[2]=D=>{$(),l("openTicketImport")}),class:"flex-shrink-0 px-3 py-1.5 text-cyan-600 text-xs rounded-lg font-medium flex items-center gap-1 transition",style:{background:"var(--nav-active-bg)",border:"1px solid rgba(6,182,212,0.2)"}},[...m[4]||(m[4]=[t("i",{class:"fas fa-camera"},null,-1),E(" 截图导入 ",-1)])])]),t("div",on,[h.value?(d(),f("div",rn,[...m[6]||(m[6]=[t("i",{class:"fas fa-spinner fa-spin"},null,-1),E(" 搜索中... ",-1)])])):u.value.length===0&&!o.value?(d(),f("div",un,[m[7]||(m[7]=t("i",{class:"fas fa-map-marked-alt text-3xl mb-2 opacity-50"},null,-1)),m[8]||(m[8]=t("p",{class:"text-sm"},"输入关键词搜索地点",-1)),a.insertAtIndex!==null?(d(),f("p",dn,"将添加为当前站点的下一站")):S("",!0)])):u.value.length===0?(d(),f("div",cn,"未找到相关地点")):S("",!0),(d(!0),f(J,null,X(u.value,D=>(d(),f("div",{key:D.name+D.address,onClick:p=>r(D),class:"p-3 rounded-lg cursor-pointer transition flex items-center gap-3",style:{"border-bottom":"1px solid var(--border-subtle)"}},[m[9]||(m[9]=t("div",{class:"w-8 h-8 rounded-full flex items-center justify-center t-text-muted flex-shrink-0",style:{background:"var(--bg-inset)"}},[t("i",{class:"fas fa-map-pin"})],-1)),t("div",null,[t("div",mn,w(D.name),1),t("div",pn,w(D.district||"")+" "+w(D.address||""),1)])],8,vn))),128))])]),_:1},8,["show","title"]))}},yn={key:0,class:"fixed inset-0 z-[70]"},xn={class:"flex justify-between items-center mb-4"},gn={class:"text-lg font-bold t-heading"},bn={class:"text-sm t-text-sub mb-3"},hn={key:0},wn=["src"],kn={key:0,class:"mt-3 text-sm text-cyan-600"},$n={key:1,class:"mt-3 text-sm text-red-500"},_n=["disabled"],Dn={__name:"TicketImportModal",props:{show:Boolean,title:{type:String,default:"导入航班 / 车票"},expectFlightOnly:{type:Boolean,default:!1}},emits:["close","imported"],setup(a,{emit:y}){const e=a,l=y,o=T(null),u=T(""),h=T(""),k=T(!1);let c=null;function r(p){const v=new FileReader;v.onload=()=>{o.value=v.result,h.value=""},v.readAsDataURL(p)}function $(p){const v=p.target.files[0];v&&v.type.startsWith("image/")&&r(v)}function b(){var p;(p=document.getElementById("ticket-file-input"))==null||p.click()}async function m(){if(o.value){k.value=!0,u.value="正在识别票据…",h.value="";try{const p=await Xt(o.value);if(p.type==="unknown"||p.error){h.value=p.error||"无法识别为机票或火车票",u.value="";return}if(e.expectFlightOnly&&p.type!=="flight"){h.value="请上传机票截图",u.value="";return}u.value=e.expectFlightOnly?"已更新为航班":"已加入当天行程",l("imported",p),l("close")}catch(p){h.value=p.message||"识别失败，请重试",u.value=""}finally{k.value=!1}}}function D(){o.value=null,u.value="",h.value="",l("close")}return dt(()=>{c=p=>{var v,x;if(e.show&&((x=(v=p.clipboardData)==null?void 0:v.files)!=null&&x.length)){const i=Array.from(p.clipboardData.files).find(C=>C.type.startsWith("image/"));i&&(p.preventDefault(),r(i))}},window.addEventListener("paste",c)}),ct(()=>{c&&window.removeEventListener("paste",c)}),(p,v)=>(d(),W(st,{to:"body"},[a.show?(d(),f("div",yn,[t("div",{class:"absolute inset-0 backdrop-blur-sm",style:{background:"var(--modal-overlay)"},onClick:D}),t("div",{class:"absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[calc(100%-2rem)] max-w-md rounded-2xl shadow-2xl p-6",style:{background:"var(--modal-bg)"},onClick:v[0]||(v[0]=at(()=>{},["stop"]))},[t("div",xn,[t("h3",gn,w(a.title),1),t("button",{type:"button",onClick:D,class:"w-8 h-8 flex items-center justify-center rounded-full t-text-sub transition",style:{background:"var(--bg-inset)"}},[...v[1]||(v[1]=[t("i",{class:"fas fa-times"},null,-1)])])]),t("p",bn,w(a.expectFlightOnly?"上传机票截图，自动识别航班信息并更新该段交通":"上传或粘贴机票、高铁票等截图，自动识别并加入当天行程"),1),t("div",{onClick:b,class:"border-2 border-dashed rounded-xl p-6 text-center cursor-pointer hover:border-cyan-400 transition",style:{"border-color":"var(--border-color)"}},[t("input",{id:"ticket-file-input",type:"file",accept:"image/*",class:"hidden",onChange:$},null,32),o.value?(d(),f("img",{key:1,src:o.value,class:"max-h-48 mx-auto rounded-lg object-contain",alt:"预览"},null,8,wn)):(d(),f("div",hn,[...v[2]||(v[2]=[t("i",{class:"fas fa-image text-4xl t-text-muted mb-2"},null,-1),t("p",{class:"text-sm t-text-sub"},[E("点击选择或 "),t("kbd",{class:"px-1.5 py-0.5 rounded text-xs",style:{background:"var(--bg-inset)"}},"Ctrl+V"),E(" 粘贴截图")],-1)])]))]),u.value?(d(),f("div",kn,w(u.value),1)):S("",!0),h.value?(d(),f("div",$n,w(h.value),1)):S("",!0),t("button",{type:"button",disabled:!o.value||k.value,class:P(["mt-4 w-full py-3 rounded-xl bg-primary text-white font-medium transition",{"opacity-50 cursor-not-allowed":!o.value||k.value}]),onClick:m},w(k.value?"识别中...":"识别并导入"),11,_n)])])):S("",!0)]))}},Tn={class:"max-w-6xl mx-auto"},Sn={key:0,class:"text-center py-20 t-text-muted animate-fade-in"},Cn={key:1,class:"animate-fade-in"},Ln={class:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6"},In={class:"flex items-center gap-3 mb-1"},Mn={class:"text-2xl font-bold t-heading"},jn={class:"glass-panel rounded-xl p-4 mb-6 flex flex-wrap gap-4 items-center"},Rn={class:"flex items-center gap-2"},On=["value"],An={class:"flex items-center gap-2"},Fn=["value"],Bn={key:0,class:"flex items-center gap-2"},Hn=["value"],En={key:1,class:"max-w-3xl mx-auto"},Nn={key:0,class:"space-y-0"},Pn=["onDragstart","onDragover","onDrop"],zn=["data-seg-idx"],qn={class:"mt-6 text-center"},Kn={__name:"PlanDetailView",setup(a){const y=Jt(),e=Kt(),l=lt(),o=Gt(),{dragIndex:u,dragOverIndex:h,onDragStart:k,onDragOver:c,onDragLeave:r,onDrop:$,onDragEnd:b}=ee(),m=T(!0),D=T(!1),p=T(null),v=T("add"),x=T(!1),i=T(!1),C=T(null),I=T(-1),F=T(!1),K=T(null),vt=T(-1),U=T(null);let Q=null;const A=g(()=>l.activePlan),z=g(()=>{var s;return((s=A.value)==null?void 0:s.days)||[]}),mt=g(()=>l.activeDetailTab==="overview"),B=g(()=>l.getCurrentDayIndex()),V=g(()=>z.value[B.value]||null),j=g(()=>{var s;return((s=V.value)==null?void 0:s.segments)||[]}),q=g(()=>V.value?(et(V.value),Qt(V.value)):[]),Tt=g(()=>j.value.length>0||l.tempStartLocation);dt(async()=>{var s,n,L;try{const O=y.params.id;if(((s=l.activePlan)==null?void 0:s.id)!==O){const H=await Yt(O);l.activePlan=H}l.activeDetailTab=0,(L=(n=A.value)==null?void 0:n.days)==null||L.forEach(H=>et(H)),l.syncTempStartLocationForCurrentDay()}catch{o.showToast("加载行程失败","error"),e.push({name:"plans"})}finally{m.value=!1}}),ct(()=>{Q&&clearTimeout(Q)}),kt(()=>l.activeDetailTab,()=>{var s,n;(n=(s=A.value)==null?void 0:s.days)!=null&&n.length&&l.syncTempStartLocationForCurrentDay()},{immediate:!1}),kt(()=>A.value,()=>{!A.value||m.value||(Q&&clearTimeout(Q),Q=setTimeout(()=>l.saveActivePlanSilently(),2e3))},{deep:!0});function St(s){l.updatePlanDepartureDate(s.target.value)}function Ct(s){const n=parseInt(s.target.value,10)||1;l.updatePlanDaysCount(n)}function Lt(s){V.value&&(V.value.start_time_hm=s.target.value||"08:00")}function rt(s,n,L){const O=z.value[s];O&&(et(O),O.location_stay_minutes[n]!==void 0&&(O.location_stay_minutes[n]=L))}function Y(s=null){v.value="add",p.value=s,D.value=!0}function pt(){v.value="replaceStart",p.value=null,D.value=!0}async function It(s){var L;D.value=!1;const n=B.value;!s.city&&((L=A.value.start_location)!=null&&L.city)&&(s.city=A.value.start_location.city),l.setDayStartLocation(n,s),l.tempStartLocation={...s},o.showToast("当日起点已更新")}async function Mt(s){if(v.value==="replaceStart"){await It(s),v.value="add";return}await jt(s)}async function jt(s){var H;D.value=!1;const n=B.value,L=z.value[n].segments;if(!s.city&&((H=A.value.start_location)!=null&&H.city)&&(s.city=A.value.start_location.city),L.length===0&&!l.tempStartLocation){l.tempStartLocation=s,n===0&&(A.value.start_location={name:s.name,lat:s.lat,lng:s.lng,address:s.address,city:s.city}),o.showToast("起点设置成功");return}if(L.length===0&&l.tempStartLocation){await l.addSegment(l.tempStartLocation,s),l.tempStartLocation=null,o.showToast("地点已添加");return}if(p.value!==null){await l.insertSegmentAt(p.value,s),o.showToast("地点已插入");return}const O=L[L.length-1].destination;await l.addSegment(O,s),o.showToast("地点已添加")}async function it(s,n){confirm("确定要删除这个地点吗？")&&(await l.removeLocation(s,n),o.showToast("地点已删除"))}function Rt(s){I.value=s,C.value=j.value[s],i.value=!0}function Ot(){i.value=!1,I.value>=0&&At(I.value)}function At(s){const n=document.querySelector(`[data-seg-idx="${s}"]`),L=(n==null?void 0:n.getBoundingClientRect())||{top:200,left:200,bottom:240,right:300};K.value=L,vt.value=s,F.value=!0}async function Ft(s){const n=vt.value;if(F.value=!1,!(n<0)){if(s==="flight"){U.value=n,x.value=!0;return}try{await l.changeTransportMode(n,s),o.showToast("交通方式已更新")}catch{o.showToast("切换交通方式失败","error")}}}function Bt(){U.value=null,D.value=!1,x.value=!0}function Ht(){x.value=!1,U.value=null}async function Et(s){if(U.value!==null){l.replaceSegmentWithTicketData(U.value,s),U.value=null,x.value=!1,o.showToast("已更新为航班");return}x.value=!1;const n=B.value,L=z.value[n].segments,O={name:s.departure_station||s.departure_city||"出发地",city:s.departure_city||"",departure_time:s.departure_time},H={name:s.arrival_station||s.arrival_city||"目的地",city:s.arrival_city||"",arrival_time:s.arrival_time},Z=s.duration_seconds?Math.round(s.duration_seconds/60):0,tt={type:s.type||"train",origin:O,destination:H,distance_km:s.distance_km||0,duration_minutes:Z,details:{flight_no:s.flight_no,train_no:s.train_no,departure_time:s.departure_time,arrival_time:s.arrival_time,seat_info:s.seat_info}};L.push(tt),et(z.value[n]),o.showToast("票据已导入"),l.saveActivePlanSilently()}async function Nt(){try{await l.saveActivePlan(),o.showToast("行程已保存")}catch{o.showToast("保存失败","error")}}async function Pt(){if(confirm("确定要删除整个行程吗？此操作不可恢复。"))try{await Zt(A.value.id),o.showToast("行程已删除"),e.push({name:"plans"})}catch{o.showToast("删除失败","error")}}return(s,n)=>{var L,O,H,Z,tt,ft,yt,xt,gt;return d(),f("div",Tn,[m.value?(d(),f("div",Sn,[...n[12]||(n[12]=[t("i",{class:"fas fa-spinner fa-spin text-4xl text-cyan-500 mb-4"},null,-1),t("p",{class:"text-lg"},"加载行程...",-1)])])):A.value?(d(),f("div",Cn,[t("div",Ln,[t("div",null,[t("div",In,[t("button",{onClick:n[0]||(n[0]=M=>_(e).push({name:"plans"})),class:"t-text-muted hover:text-cyan-500 transition"},[...n[13]||(n[13]=[t("i",{class:"fas fa-arrow-left mr-1"},null,-1),E(" 返回 ",-1)])])]),t("h1",Mn,w(A.value.title||"未命名行程"),1)]),t("div",{class:"flex items-center gap-2 flex-wrap"},[t("button",{onClick:Nt,class:"px-4 py-2 bg-gradient-to-r from-cyan-600 to-blue-600 text-white rounded-lg hover:shadow-lg transition flex items-center gap-2 font-medium text-sm"},[...n[14]||(n[14]=[t("i",{class:"fas fa-save"},null,-1),E(" 保存 ",-1)])]),t("button",{onClick:Pt,class:"px-4 py-2 rounded-lg border transition t-text-sub hover:text-red-500 hover:border-red-400 text-sm",style:{"border-color":"var(--border-color)"}},[...n[15]||(n[15]=[t("i",{class:"fas fa-trash-alt mr-1"},null,-1),E(" 删除 ",-1)])])])]),t("div",jn,[t("div",Rn,[n[16]||(n[16]=t("i",{class:"far fa-calendar-alt text-cyan-500"},null,-1)),n[17]||(n[17]=t("label",{class:"text-xs t-text-muted font-medium"},"出发日期",-1)),t("input",{type:"date",value:((L=z.value[0])==null?void 0:L.date)||"",class:"rounded-lg px-3 py-1.5 text-sm border outline-none",onChange:St},null,40,On)]),t("div",An,[n[18]||(n[18]=t("i",{class:"fas fa-hashtag text-cyan-500"},null,-1)),n[19]||(n[19]=t("label",{class:"text-xs t-text-muted font-medium"},"天数",-1)),t("input",{type:"number",value:z.value.length,min:"1",max:"30",class:"w-16 rounded-lg px-3 py-1.5 text-sm border outline-none text-center",onChange:Ct},null,40,Fn)]),mt.value?S("",!0):(d(),f("div",Bn,[n[20]||(n[20]=t("i",{class:"far fa-clock text-cyan-500"},null,-1)),n[21]||(n[21]=t("label",{class:"text-xs t-text-muted font-medium"},"当日出发时间",-1)),t("input",{type:"time",value:((O=V.value)==null?void 0:O.start_time_hm)||"08:00",class:"rounded-lg px-3 py-1.5 text-sm border outline-none",onChange:Lt},null,40,Hn)]))]),G(le,{days:z.value},null,8,["days"]),mt.value?(d(),W(ve,{key:0,days:z.value},null,8,["days"])):(d(),f("div",En,[Tt.value?(d(),f("div",Nn,[j.value.length===0&&_(l).tempStartLocation?(d(),W(ut,{key:0,location:_(l).tempStartLocation,index:0,"is-last":!0,"role-label":(B.value===0,"起点"),"arrival-hm":((H=q.value[0])==null?void 0:H.arrivalHm)||"--","stay-minutes":((Z=q.value[0])==null?void 0:Z.stayMinutes)||0,"departure-hm":(tt=q.value[0])==null?void 0:tt.departureHm,"day-index":B.value,"can-edit-start":!0,onInsert:Y,onEditStart:pt,onRemove:it,onUpdateStay:rt},null,8,["location","role-label","arrival-hm","stay-minutes","departure-hm","day-index"])):S("",!0),(d(!0),f(J,null,X(j.value,(M,R)=>{var bt,ht,wt;return d(),f(J,{key:R},[t("div",{draggable:"true",onDragstart:N=>_(k)(N,R),onDragover:N=>_(c)(N,R),onDragleave:n[1]||(n[1]=(...N)=>_(r)&&_(r)(...N)),onDrop:N=>_($)(N,R,B.value),onDragend:n[2]||(n[2]=(...N)=>_(b)&&_(b)(...N)),class:P({"opacity-50":_(u)===R,"ring-2 ring-cyan-400 rounded-xl":_(h)===R})},[G(ut,{location:M.origin,index:R,"is-last":!1,"role-label":R===0&&B.value===0||R===0?"起点":null,"arrival-hm":((bt=q.value[R])==null?void 0:bt.arrivalHm)||"--","stay-minutes":((ht=q.value[R])==null?void 0:ht.stayMinutes)||0,"departure-hm":(wt=q.value[R])==null?void 0:wt.departureHm,"day-index":B.value,"can-edit-start":R===0,onInsert:Y,onEditStart:pt,onRemove:it,onUpdateStay:rt},null,8,["location","index","role-label","arrival-hm","stay-minutes","departure-hm","day-index","can-edit-start"])],42,Pn),t("div",{"data-seg-idx":R},[G(He,{segment:M,index:R,onOpenDetail:N=>Rt(R)},null,8,["segment","index","onOpenDetail"])],8,zn)],64)}),128)),j.value.length>0?(d(),f("div",{key:1,draggable:"true",onDragstart:n[3]||(n[3]=M=>_(k)(M,j.value.length)),onDragover:n[4]||(n[4]=M=>_(c)(M,j.value.length)),onDragleave:n[5]||(n[5]=(...M)=>_(r)&&_(r)(...M)),onDrop:n[6]||(n[6]=M=>_($)(M,j.value.length,B.value)),onDragend:n[7]||(n[7]=(...M)=>_(b)&&_(b)(...M)),class:P({"opacity-50":_(u)===j.value.length,"ring-2 ring-cyan-400 rounded-xl":_(h)===j.value.length})},[G(ut,{location:j.value[j.value.length-1].destination,index:j.value.length,"is-last":!0,"role-label":"终点","arrival-hm":((ft=q.value[j.value.length])==null?void 0:ft.arrivalHm)||"--","stay-minutes":((yt=q.value[j.value.length])==null?void 0:yt.stayMinutes)||0,"departure-hm":(xt=q.value[j.value.length])==null?void 0:xt.departureHm,"day-index":B.value,onInsert:Y,onRemove:it,onUpdateStay:rt},null,8,["location","index","arrival-hm","stay-minutes","departure-hm","day-index"])],34)):S("",!0)])):S("",!0),t("div",qn,[t("button",{type:"button",onClick:n[8]||(n[8]=M=>Y(null)),class:"px-6 py-3 border-2 border-dashed border-cyan-400/50 rounded-xl text-cyan-500 hover:bg-cyan-500/10 hover:border-cyan-400 transition flex items-center gap-2 mx-auto"},[...n[22]||(n[22]=[t("i",{class:"fas fa-plus"},null,-1),E(" 添加下一站目的地 ",-1)])])])]))])):S("",!0),G(fn,{show:D.value,title:v.value==="replaceStart"?"修改当日起点":"添加行程地点",city:((gt=V.value)==null?void 0:gt.city)||"","insert-at-index":p.value,onClose:n[9]||(n[9]=M=>D.value=!1),onSelect:Mt,onOpenTicketImport:Bt},null,8,["show","title","city","insert-at-index"]),G(Dn,{show:x.value,title:U.value!==null?"上传机票截图":"导入航班 / 车票","expect-flight-only":U.value!==null,onClose:Ht,onImported:Et},null,8,["show","title","expect-flight-only"]),G(Ze,{show:i.value,segment:C.value,onClose:n[10]||(n[10]=M=>i.value=!1),onChange:Ot},null,8,["show","segment"]),F.value?(d(),W(Pe,{key:2,show:F.value,"trigger-rect":K.value,onSelect:Ft,onClose:n[11]||(n[11]=M=>F.value=!1)},null,8,["show","trigger-rect"])):S("",!0)])}}};export{Kn as default};
