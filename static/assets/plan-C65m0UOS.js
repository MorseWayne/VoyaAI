import{C as J,f as H}from"./index-BCAT3486.js";import{s as b}from"./plans-CWatqful.js";import{p as F}from"./client-Be4OVhjz.js";function K(t,i,l,m){return F("/travel/optimize",{locations:t,city:i,strategy:l,preference:m})}function w(t,i,l,m=""){return F("/travel/calculate-segment",{origin:t,destination:i,mode:l,city:m})}function Q(t){if(!t)return"0分钟";const i=Math.floor(t/3600),l=Math.floor(t%3600/60);return i>0?`${i}小时${l}分钟`:`${l}分钟`}function z(t){if(!t||typeof t!="string")return NaN;const i=t.trim();if(/^\d{4}-\d{2}-\d{2}\s+\d{1,2}:\d{2}/.test(i))return new Date(i.replace(/-/g,"/")).getTime();if(/^\d{1,2}:\d{2}/.test(i)){const[l,m]=i.split(":").map(Number);return(l*60+m)*60*1e3}return NaN}function D(t){if(t==null||t<0)return"--";const i=Math.floor(t/60)%24,l=Math.floor(t%60);return`${String(i).padStart(2,"0")}:${String(l).padStart(2,"0")}`}function R(t){if(typeof t!="string")return 0;const i=t.trim().match(/^(\d{1,2}):(\d{2})$/);return i?parseInt(i[1],10)*60+parseInt(i[2],10):0}function A(t){if(!t||typeof t!="string")return null;const i=z(t.trim());if(Number.isNaN(i))return null;const l=new Date(i);return l.getHours()*60+l.getMinutes()}function j(t){var m,u,p,v;if(!t||t.type!=="flight"&&t.type!=="train")return!1;const i=((m=t.details)==null?void 0:m.departure_time)||((u=t.origin)==null?void 0:u.departure_time),l=((p=t.details)==null?void 0:p.arrival_time)||((v=t.destination)==null?void 0:v.arrival_time);return!!(i&&l&&A(i)!=null&&A(l)!=null)}function O(t){if(!t)return;const i=t.segments&&t.segments.length?t.segments.length+1:1;for(t.location_stay_minutes||(t.location_stay_minutes=[]);t.location_stay_minutes.length<i;)t.location_stay_minutes.push(0);t.location_stay_minutes.length>i&&(t.location_stay_minutes.length=i)}function U(t){var S,$,P,f;const i=t.segments||[],l=t.location_stay_minutes||[],m=t.start_time_hm||"08:00";let u=R(m);const p=[];for(let M=0;M<i.length;M++){const _=i[M],k=Math.max(0,parseFloat(l[M])||0);if(j(_)){const h=((S=_.details)==null?void 0:S.departure_time)||(($=_.origin)==null?void 0:$.departure_time),T=((P=_.details)==null?void 0:P.arrival_time)||((f=_.destination)==null?void 0:f.arrival_time),e=A(h),n=A(T);p.push({arrivalMinutes:u,arrivalHm:D(u),stayMinutes:k,departureMinutes:e,departureHm:D(e)}),u=n}else{const h=u+k;p.push({arrivalMinutes:u,arrivalHm:D(u),stayMinutes:k,departureMinutes:h,departureHm:D(h)});const T=Math.max(0,parseFloat(_.duration_minutes)||0);u=h+T}}const v=Math.max(0,parseFloat(l[i.length])||0);return p.push({arrivalMinutes:u,arrivalHm:D(u),stayMinutes:v,departureMinutes:u+v,departureHm:D(u+v)}),p}const V=J("plan",()=>{const t=H(null),i=H(0),l=H(null),m=H(null);function u(){return i.value==="overview"?0:i.value}async function p(){if(!t.value)return;const e=JSON.parse(JSON.stringify(t.value));delete e.tempStartLocation,(e.days||[]).forEach(n=>{(n.segments||[]).forEach(o=>{delete o._amapAttempted})});try{const n=await b(e);n.id&&(t.value.id=n.id),n.created_at&&(t.value.created_at=n.created_at)}catch(n){console.error("[auto-save]",n)}}async function v(){if(!t.value)return;const e=JSON.parse(JSON.stringify(t.value));delete e.tempStartLocation,(e.days||[]).forEach(o=>{(o.segments||[]).forEach(a=>{delete a._amapAttempted})});const n=await b(e);return n.id&&(t.value.id=n.id),n.created_at&&(t.value.created_at=n.created_at),n}function S(){var a,s;if(!t.value||!t.value.days.length)return;const e=((a=t.value.start_location)==null?void 0:a.name)||((s=t.value.title)!=null&&s.includes(" · ")?t.value.title.split(" · ")[0].trim():""),n=t.value.days[0].date?new Date(t.value.days[0].date).toLocaleDateString("zh-CN",{month:"long",day:"numeric"}):"",o=t.value.days.length;t.value.title=e?`${e} · ${n}出发 · ${o}日旅行`:`${n}出发 · ${o}日旅行`}function $(e){if(!t.value||!e||!t.value.days.length)return;const n=new Date(e);t.value.days.forEach((o,a)=>{const s=new Date(n);s.setDate(s.getDate()+a),o.date=s.toISOString().split("T")[0]}),S()}function P(e){if(!t.value||e<1||e>30)return;const n=t.value.days.length;if(e!==n){if(e<n){if(t.value.days.slice(e).some(s=>s.segments&&s.segments.length>0)&&!confirm(`将删除第 ${e+1}～${n} 天的行程内容，确定继续？`))return!1;t.value.days.length=e,i.value!=="overview"&&i.value>=e&&(i.value=e-1)}else{const o=t.value.days[t.value.days.length-1].date,a=o?new Date(o):new Date;for(let s=n;s<e;s++){const r=new Date(a);r.setDate(r.getDate()+(s-n+1)),t.value.days.push({day_index:s+1,date:r.toISOString().split("T")[0],city:t.value.days[0].city||"",segments:[],start_time_hm:"08:00"})}}return S(),!0}}async function f(e,n,o){var s,r,c;const a=((c=(r=(s=t.value)==null?void 0:s.days)==null?void 0:r[u()])==null?void 0:c.city)||"";return w(e.name,n.name,o,a)}async function M(e,n){const o="driving";try{const a=await f(e,n,o);t.value.days[u()].segments.push({type:o,origin:e,destination:n,distance_km:a.distance_km,duration_minutes:a.duration_minutes})}catch{t.value.days[u()].segments.push({type:o,origin:e,destination:n,distance_km:0,duration_minutes:0})}O(t.value.days[u()])}async function _(e,n){const o=u(),a=t.value.days[o].segments,s="driving";n.city&&!t.value.days[o].city&&(t.value.days[o].city=n.city);try{if(e===0){const c=a[0].origin,y=await f(n,c,s);a.unshift({type:s,origin:n,destination:c,distance_km:y.distance_km,duration_minutes:y.duration_minutes})}else{const c=a[e-1],[y,g]=await Promise.all([f(c.origin,n,s),f(n,c.destination,s)]).catch(()=>[{distance_km:0,duration_minutes:0},{distance_km:0,duration_minutes:0}]);a.splice(e-1,1,{type:s,origin:c.origin,destination:n,distance_km:y.distance_km,duration_minutes:y.duration_minutes},{type:s,origin:n,destination:c.destination,distance_km:g.distance_km,duration_minutes:g.duration_minutes})}}catch{if(e===0)a.unshift({type:s,origin:n,destination:a[0].origin,distance_km:0,duration_minutes:0});else{const c=a[e-1];a.splice(e-1,1,{type:s,origin:c.origin,destination:n,distance_km:0,duration_minutes:0},{type:s,origin:n,destination:c.destination,distance_km:0,duration_minutes:0})}}O(t.value.days[o]);const r=t.value.days[o].location_stay_minutes;r&&e>=0&&e<=r.length&&r.splice(e,0,0)}async function k(e,n){const o=u(),a=t.value.days[o].segments;if(m.value&&a.length===0){m.value=null;return}const s=t.value.days[o];O(s);const r=s.location_stay_minutes;if(e===0)a.length===1?(m.value=a[0].destination,a.shift(),r.length>0&&r.shift()):(a.shift(),r.length>0&&r.shift());else if(n)a.pop(),r.length>0&&r.pop();else{const c=a[e-1],y=a[e],g=c.origin,N=y.destination;a.splice(e-1,2),r.length>e&&r.splice(e,1);try{const d=await f(g,N,"driving");a.splice(e-1,0,{type:"driving",origin:g,destination:N,distance_km:d.distance_km,duration_minutes:d.duration_minutes})}catch{a.splice(e-1,0,{type:"driving",origin:g,destination:N,distance_km:0,duration_minutes:0})}}}async function h(e,n){const o=u(),a=t.value.days[o].segments[e];if(!a||a.type===n)return;const s=await f(a.origin,a.destination,n);a.type=n,a.distance_km=s.distance_km,a.duration_minutes=s.duration_minutes}async function T(e,n,o){const a=t.value.days[e],s=a.segments,r=[];if(s.length>0)r.push(s[0].origin),s.forEach(d=>r.push(d.destination));else return;if(n<0||n>=r.length||o<0||o>=r.length)return;const[c]=r.splice(n,1);r.splice(o,0,c),e===0&&r.length>0&&(t.value.start_location={name:r[0].name,address:r[0].address,city:r[0].city,lat:r[0].lat,lng:r[0].lng},m.value=null),O(a);const[y]=a.location_stay_minutes.splice(n,1);a.location_stay_minutes.splice(o,0,y);const g=[];for(let d=0;d<r.length-1;d++)g.push({type:"driving",origin:r[d],destination:r[d+1],distance_km:0,duration_minutes:0});a.segments=g;const N=g.map(d=>f(d.origin,d.destination,d.type).then(E=>{d.distance_km=E.distance_km,d.duration_minutes=E.duration_minutes}).catch(()=>{}));await Promise.all(N),p()}return{activePlan:t,activeDetailTab:i,currentPlanData:l,tempStartLocation:m,getCurrentDayIndex:u,saveActivePlanSilently:p,saveActivePlan:v,syncPlanTitleFromMeta:S,updatePlanDepartureDate:$,updatePlanDaysCount:P,calculateSegmentData:f,addSegment:M,insertSegmentAt:_,removeLocation:k,changeTransportMode:h,reorderLocations:T}});export{O as e,Q as f,U as g,K as o,V as u};
