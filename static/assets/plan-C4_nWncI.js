import{C as G,f as b}from"./index-Dt4hLyz-.js";import{s as L}from"./plans-CWatqful.js";import{p as j}from"./client-Be4OVhjz.js";function Z(t,r,u,c){return j("/travel/optimize",{locations:t,city:r,strategy:u,preference:c})}function K(t,r,u,c=""){return j("/travel/calculate-segment",{origin:t,destination:r,mode:u,city:c})}function C(t){if(!t)return"0分钟";const r=Math.floor(t/3600),u=Math.floor(t%3600/60);return r>0?`${r}小时${u}分钟`:`${u}分钟`}function J(t){if(!t||typeof t!="string")return NaN;const r=t.trim();if(/^\d{4}-\d{2}-\d{2}\s+\d{1,2}:\d{2}/.test(r))return new Date(r.replace(/-/g,"/")).getTime();if(/^\d{1,2}:\d{2}/.test(r)){const[u,c]=r.split(":").map(Number);return(u*60+c)*60*1e3}return NaN}function I(t,r){const u=J(t),c=J(r);return Number.isNaN(u)||Number.isNaN(c)||c<=u?0:Math.round((c-u)/1e3)}function N(t){if(t==null||t<0)return"--";const r=Math.floor(t/60)%24,u=Math.floor(t%60);return`${String(r).padStart(2,"0")}:${String(u).padStart(2,"0")}`}function Q(t){if(typeof t!="string")return 0;const r=t.trim().match(/^(\d{1,2}):(\d{2})$/);return r?parseInt(r[1],10)*60+parseInt(r[2],10):0}function E(t){if(!t||typeof t!="string")return null;const r=J(t.trim());if(Number.isNaN(r))return null;const u=new Date(r);return u.getHours()*60+u.getMinutes()}function U(t){var c,l,y,p;if(!t)return!1;const r=((c=t.details)==null?void 0:c.departure_time)||((l=t.origin)==null?void 0:l.departure_time),u=((y=t.details)==null?void 0:y.arrival_time)||((p=t.destination)==null?void 0:p.arrival_time);return!!(r&&u&&E(r)!=null&&E(u)!=null)}function A(t){if(!t)return;const r=t.segments&&t.segments.length?t.segments.length+1:1;for(t.location_stay_minutes||(t.location_stay_minutes=[]);t.location_stay_minutes.length<r;)t.location_stay_minutes.push(0);t.location_stay_minutes.length>r&&(t.location_stay_minutes.length=r)}function x(t){var P,H,M,k;const r=t.segments||[],u=t.location_stay_minutes||[],c=t.start_time_hm||"08:00";let l=Q(c);const y=[];for(let v=0;v<r.length;v++){const h=r[v],T=Math.max(0,parseFloat(u[v])||0);if(U(h)){const g=((P=h.details)==null?void 0:P.departure_time)||((H=h.origin)==null?void 0:H.departure_time),D=((M=h.details)==null?void 0:M.arrival_time)||((k=h.destination)==null?void 0:k.arrival_time),O=E(g),F=E(D);y.push({arrivalMinutes:l,arrivalHm:N(l),stayMinutes:T,departureMinutes:O,departureHm:N(O)}),l=F}else{const g=l+T;y.push({arrivalMinutes:l,arrivalHm:N(l),stayMinutes:T,departureMinutes:g,departureHm:N(g)});const D=Math.max(0,parseFloat(h.duration_minutes)||0);l=g+D}}const p=Math.max(0,parseFloat(u[r.length])||0);return y.push({arrivalMinutes:l,arrivalHm:N(l),stayMinutes:p,departureMinutes:l+p,departureHm:N(l+p)}),y}const tt=G("plan",()=>{const t=b(null),r=b(0),u=b(null),c=b(null);function l(){return r.value==="overview"?0:r.value}function y(n){var i;const s=(((i=t.value)==null?void 0:i.days)||[])[n];if(!s)return null;const a=s.segments||[];return a.length>0?a[a.length-1].destination:p(n)}function p(n){var a,i;const e=((a=t.value)==null?void 0:a.days)||[];if(n===0)return((i=t.value)==null?void 0:i.start_location)??null;const s=e[n];return s?s.start_location?s.start_location:y(n-1):null}function P(n,e){if(!t.value)return;const s={name:e.name,lat:e.lat,lng:e.lng,address:e.address,city:e.city};if(n===0)t.value.start_location=s;else{const a=t.value.days[n];a&&(a.start_location=s)}}function H(){var i,o;const n=l(),s=(((i=t.value)==null?void 0:i.days)||[])[n];if(((o=s==null?void 0:s.segments)==null?void 0:o.length)>0){c.value=null;return}c.value=p(n)||null}async function M(){if(!t.value)return;const n=JSON.parse(JSON.stringify(t.value));delete n.tempStartLocation,(n.days||[]).forEach(e=>{(e.segments||[]).forEach(s=>{delete s._amapAttempted})});try{const e=await L(n);e.id&&(t.value.id=e.id),e.created_at&&(t.value.created_at=e.created_at)}catch(e){console.error("[auto-save]",e)}}async function k(){if(!t.value)return;const n=JSON.parse(JSON.stringify(t.value));delete n.tempStartLocation,(n.days||[]).forEach(s=>{(s.segments||[]).forEach(a=>{delete a._amapAttempted})});const e=await L(n);return e.id&&(t.value.id=e.id),e.created_at&&(t.value.created_at=e.created_at),e}function v(){var a,i;if(!t.value||!t.value.days.length)return;const n=((a=t.value.start_location)==null?void 0:a.name)||((i=t.value.title)!=null&&i.includes(" · ")?t.value.title.split(" · ")[0].trim():""),e=t.value.days[0].date?new Date(t.value.days[0].date).toLocaleDateString("zh-CN",{month:"long",day:"numeric"}):"",s=t.value.days.length;t.value.title=n?`${n} · ${e}出发 · ${s}日旅行`:`${e}出发 · ${s}日旅行`}function h(n){if(!t.value||!n||!t.value.days.length)return;const e=new Date(n);t.value.days.forEach((s,a)=>{const i=new Date(e);i.setDate(i.getDate()+a),s.date=i.toISOString().split("T")[0]}),v()}function T(n){if(!t.value||n<1||n>30)return;const e=t.value.days.length;if(n!==e){if(n<e){if(t.value.days.slice(n).some(i=>i.segments&&i.segments.length>0)&&!confirm(`将删除第 ${n+1}～${e} 天的行程内容，确定继续？`))return!1;t.value.days.length=n,r.value!=="overview"&&r.value>=n&&(r.value=n-1)}else{const s=t.value.days[t.value.days.length-1].date,a=s?new Date(s):new Date;for(let i=e;i<n;i++){const o=new Date(a);o.setDate(o.getDate()+(i-e+1)),t.value.days.push({day_index:i+1,date:o.toISOString().split("T")[0],city:t.value.days[0].city||"",segments:[],start_time_hm:"08:00"})}}return v(),!0}}async function g(n,e,s){var i,o,d;const a=((d=(o=(i=t.value)==null?void 0:i.days)==null?void 0:o[l()])==null?void 0:d.city)||"";return K(n.name,e.name,s,a)}async function D(n,e){const s="driving";try{const a=await g(n,e,s);t.value.days[l()].segments.push({type:s,origin:n,destination:e,distance_km:a.distance_km,duration_minutes:a.duration_minutes})}catch{t.value.days[l()].segments.push({type:s,origin:n,destination:e,distance_km:0,duration_minutes:0})}A(t.value.days[l()])}async function O(n,e){const s=l(),a=t.value.days[s].segments,i="driving";e.city&&!t.value.days[s].city&&(t.value.days[s].city=e.city);try{if(n===0){const d=a[0].origin,f=await g(e,d,i);a.unshift({type:i,origin:e,destination:d,distance_km:f.distance_km,duration_minutes:f.duration_minutes})}else{const d=a[n-1],[f,_]=await Promise.all([g(d.origin,e,i),g(e,d.destination,i)]).catch(()=>[{distance_km:0,duration_minutes:0},{distance_km:0,duration_minutes:0}]);a.splice(n-1,1,{type:i,origin:d.origin,destination:e,distance_km:f.distance_km,duration_minutes:f.duration_minutes},{type:i,origin:e,destination:d.destination,distance_km:_.distance_km,duration_minutes:_.duration_minutes})}}catch{if(n===0)a.unshift({type:i,origin:e,destination:a[0].origin,distance_km:0,duration_minutes:0});else{const d=a[n-1];a.splice(n-1,1,{type:i,origin:d.origin,destination:e,distance_km:0,duration_minutes:0},{type:i,origin:e,destination:d.destination,distance_km:0,duration_minutes:0})}}A(t.value.days[s]);const o=t.value.days[s].location_stay_minutes;o&&n>=0&&n<=o.length&&o.splice(n,0,0)}async function F(n,e){const s=l(),a=t.value.days[s].segments;if(c.value&&a.length===0){c.value=null;return}const i=t.value.days[s];A(i);const o=i.location_stay_minutes;if(n===0)a.length===1?(c.value=a[0].destination,a.shift(),o.length>0&&o.shift()):(a.shift(),o.length>0&&o.shift());else if(e)a.pop(),o.length>0&&o.pop();else{const d=a[n-1],f=a[n],_=d.origin,S=f.destination;a.splice(n-1,2),o.length>n&&o.splice(n,1);try{const m=await g(_,S,"driving");a.splice(n-1,0,{type:"driving",origin:_,destination:S,distance_km:m.distance_km,duration_minutes:m.duration_minutes})}catch{a.splice(n-1,0,{type:"driving",origin:_,destination:S,distance_km:0,duration_minutes:0})}}}async function W(n,e){const s=l(),a=t.value.days[s].segments[n];if(!a||a.type===e)return;const i=await g(a.origin,a.destination,e);a.type=e,a.distance_km=i.distance_km,a.duration_minutes=i.duration_minutes}function q(n,e){var _,S,m,$,w,z,R;const s=l(),a=(m=(S=(_=t.value)==null?void 0:_.days)==null?void 0:S[s])==null?void 0:m.segments;if(!a||n<0||n>=a.length)return;const i=a[n],o={...i.origin,name:e.departure_station||e.origin_name||(($=i.origin)==null?void 0:$.name)||"出发地",city:e.departure_city||e.origin_city||((w=i.origin)==null?void 0:w.city)||"",departure_time:e.departure_time},d={...i.destination,name:e.arrival_station||e.destination_name||((z=i.destination)==null?void 0:z.name)||"目的地",city:e.arrival_city||e.destination_city||((R=i.destination)==null?void 0:R.city)||"",arrival_time:e.arrival_time},f=e.duration_seconds?Math.round(e.duration_seconds/60):i.duration_minutes||0;i.type=e.type||"flight",i.origin=o,i.destination=d,i.distance_km=e.distance_km??i.distance_km??0,i.duration_minutes=f,i.details={flight_no:e.flight_no,train_no:e.train_no,departure_time:e.departure_time,arrival_time:e.arrival_time,seat_info:e.seat_info},M()}async function B(n,e,s){const a=t.value.days[n],i=a.segments,o=[];if(i.length>0)o.push(i[0].origin),i.forEach(m=>o.push(m.destination));else return;if(e<0||e>=o.length||s<0||s>=o.length)return;const[d]=o.splice(e,1);o.splice(s,0,d),n===0&&o.length>0&&(t.value.start_location={name:o[0].name,address:o[0].address,city:o[0].city,lat:o[0].lat,lng:o[0].lng},c.value=null),A(a);const[f]=a.location_stay_minutes.splice(e,1);a.location_stay_minutes.splice(s,0,f);const _=[];for(let m=0;m<o.length-1;m++)_.push({type:"driving",origin:o[m],destination:o[m+1],distance_km:0,duration_minutes:0});a.segments=_;const S=_.map(m=>g(m.origin,m.destination,m.type).then($=>{m.distance_km=$.distance_km,m.duration_minutes=$.duration_minutes}).catch(()=>{}));await Promise.all(S),M()}return{activePlan:t,activeDetailTab:r,currentPlanData:u,tempStartLocation:c,getCurrentDayIndex:l,getDayStartLocation:p,getDayEndLocation:y,setDayStartLocation:P,syncTempStartLocationForCurrentDay:H,saveActivePlanSilently:M,saveActivePlan:k,syncPlanTitleFromMeta:v,updatePlanDepartureDate:h,updatePlanDaysCount:T,calculateSegmentData:g,addSegment:D,insertSegmentAt:O,removeLocation:F,changeTransportMode:W,replaceSegmentWithTicketData:q,reorderLocations:B}});export{I as d,A as e,C as f,x as g,Z as o,tt as u};
