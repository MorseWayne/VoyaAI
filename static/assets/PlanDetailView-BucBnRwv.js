import{f as D,a as d,c as v,b as t,m as Z,u as h,n as N,F as W,r as J,t as b,h as C,l as tt,p as g,o as rt,q as At,s as it,k as U,T as et,e as H,x as Bt,y as Ht,w as Ot,v as Rt,i as Pt,z as Nt,A as V,B as Ft,g as Et}from"./index-BCAT3486.js";import{u as nt,f as gt,e as Y,g as zt}from"./plan-C65m0UOS.js";import{p as qt,a as Ut,d as Vt}from"./plans-CWatqful.js";import{s as Wt}from"./locations-CCAFugoJ.js";import"./client-Be4OVhjz.js";function Gt(){const i=nt(),x=D(null),e=D(null);function o(f,u){x.value=u,f.dataTransfer.effectAllowed="move",f.dataTransfer.setData("text/plain",String(u))}function r(f,u){f.preventDefault(),f.dataTransfer.dropEffect="move",e.value=u}function m(){e.value=null}async function k(f,u,w){f.preventDefault();const y=x.value;if(e.value=null,y===null||y===u){x.value=null;return}await i.reorderLocations(w,y,u),x.value=null}function $(){x.value=null,e.value=null}return{dragIndex:x,dragOverIndex:e,onDragStart:o,onDragOver:r,onDragLeave:m,onDrop:k,onDragEnd:$}}const Jt={class:"mb-4",style:{"border-bottom":"1px solid var(--border-color)"}},Kt={class:"flex gap-2 overflow-x-auto py-2 -mx-1 px-1 min-h-[44px] items-center"},Qt=["onClick"],Xt={__name:"DayTabs",props:{days:{type:Array,required:!0}},setup(i){const x=nt();return(e,o)=>(d(),v("div",Jt,[t("div",Kt,[t("button",{type:"button",onClick:o[0]||(o[0]=r=>h(x).activeDetailTab="overview"),class:N(["flex-shrink-0 px-4 py-2 rounded-full text-sm font-medium transition whitespace-nowrap",h(x).activeDetailTab==="overview"?"bg-cyan-600 text-white shadow-lg shadow-cyan-500/20":"t-text-sub"]),style:Z(h(x).activeDetailTab!=="overview"?"background: var(--bg-card); border: 1px solid var(--border-color);":"")}," 总览 ",6),(d(!0),v(W,null,J(i.days,(r,m)=>(d(),v("button",{key:m,type:"button",onClick:k=>h(x).activeDetailTab=m,class:N(["flex-shrink-0 px-4 py-2 rounded-full text-sm font-medium transition whitespace-nowrap",h(x).activeDetailTab===m?"bg-cyan-600 text-white shadow-lg shadow-cyan-500/20":"t-text-sub"]),style:Z(h(x).activeDetailTab!==m?"background: var(--bg-card); border: 1px solid var(--border-color);":"")}," 第 "+b(m+1)+" 天 ",15,Qt))),128))])]))}},Yt={class:"space-y-4"},Zt=["onClick"],te={class:"flex justify-between items-center"},ee={class:"font-bold t-text group-hover:text-cyan-500 transition"},ne={class:"text-sm t-text-muted"},se={class:"text-sm t-text-sub mt-1"},ae={__name:"DayOverview",props:{days:{type:Array,required:!0}},setup(i){const x=nt();return(e,o)=>(d(),v("div",Yt,[(d(!0),v(W,null,J(i.days,(r,m)=>(d(),v("div",{key:m,onClick:k=>h(x).activeDetailTab=m,class:"rounded-xl p-4 cursor-pointer transition group",style:{background:"var(--bg-card)",border:"1px solid var(--border-color)"}},[t("div",te,[t("span",ee,"第 "+b(m+1)+" 天",1),t("span",ne,b(r.date?new Date(r.date).toLocaleDateString("zh-CN",{month:"long",day:"numeric"}):`第 ${m+1} 天`),1)]),t("p",se,b((r.segments||[]).length>0?r.segments.length+1:0)+" 个地点",1)],8,Zt))),128))]))}},le={class:"timeline-item group relative"},oe={class:"timeline-rail"},re={class:"text-sm font-bold font-mono"},ie={class:"timeline-time"},ue={key:0,class:"timeline-line"},de={class:"flex-1 min-w-0 pb-2"},ce={class:"flex justify-between items-start gap-3"},me={class:"min-w-0 flex-1"},ve={class:"flex items-center flex-wrap gap-2 mb-1.5"},pe={class:"font-bold t-heading text-lg leading-snug"},fe={key:0,class:"px-2 py-0.5 rounded-full text-xs font-bold shadow-sm",style:{background:"var(--badge-start-bg)",color:"var(--badge-start-text)"}},xe={key:1,class:"px-2 py-0.5 rounded-full text-xs font-bold shadow-sm",style:{background:"var(--badge-end-bg)",color:"var(--badge-end-text)"}},ye={class:"text-sm t-text-sub flex items-center gap-1.5 mb-3"},ge={class:"truncate opacity-80"},be={class:"flex items-center gap-4 flex-wrap"},he={class:"inline-flex items-center gap-2 rounded-lg px-2.5 py-1",style:{background:"var(--bg-inset)",border:"1px solid var(--border-subtle)"}},we={class:"text-xs t-text-sub font-medium"},ke=["value"],ot={__name:"LocationCard",props:{location:{type:Object,default:null},index:{type:Number,required:!0},isLast:{type:Boolean,default:!1},roleLabel:{type:String,default:null},arrivalHm:{type:String,default:"--"},stayMinutes:{type:Number,default:0},dayIndex:{type:Number,default:0},departureHm:{type:String,default:null}},emits:["insert","remove","updateStay"],setup(i,{emit:x}){const e=i,o=x,r=g(()=>{var f;return(f=e.location)!=null&&f.name?e.location.name:e.roleLabel==="起点"?"起点（待补充）":e.roleLabel==="终点"?"终点（待补充）":"未知地点"}),m=g(()=>{var f,u,w;return((f=e.location)==null?void 0:f.address)||((u=e.location)==null?void 0:u.city)||((w=e.location)==null?void 0:w.name)||"未知地址"}),k=g(()=>e.departureHm&&e.stayMinutes>0?`到达 ${e.arrivalHm} · 离开 ${e.departureHm}`:`到达 ${e.arrivalHm}`);function $(f){const u=Math.max(0,Math.min(480,parseInt(f.target.value,10)||0));o("updateStay",e.dayIndex,e.index,u)}return(f,u)=>(d(),v("div",le,[t("div",oe,[t("div",{class:N(["timeline-node",{"bg-emerald-500 border-emerald-300 text-white shadow-emerald-500/30":i.roleLabel==="起点","bg-rose-500 border-rose-300 text-white shadow-rose-500/30":i.isLast&&i.roleLabel==="终点"}])},[t("span",re,b(i.index+1),1)],2),t("div",ie,b(i.arrivalHm),1),i.isLast?C("",!0):(d(),v("div",ue))]),t("div",de,[t("div",{class:N(["location-card",{"is-start":i.roleLabel==="起点","is-end":i.roleLabel==="终点"}])},[t("div",ce,[t("div",me,[t("div",ve,[t("h4",pe,b(r.value),1),i.roleLabel==="起点"?(d(),v("span",fe,"起点")):C("",!0),i.roleLabel==="终点"?(d(),v("span",xe,"终点")):C("",!0)]),t("p",ye,[u[4]||(u[4]=t("i",{class:"fas fa-map-marker-alt text-cyan-500/70 text-xs"},null,-1)),t("span",ge,b(m.value),1)]),t("div",be,[t("div",he,[u[5]||(u[5]=t("i",{class:"far fa-clock t-text-muted text-xs"},null,-1)),t("span",we,b(k.value),1)]),t("div",{class:"inline-flex items-center gap-1.5",onClick:u[0]||(u[0]=tt(()=>{},["stop"]))},[u[6]||(u[6]=t("i",{class:"fas fa-hourglass-half t-text-muted text-xs"},null,-1)),u[7]||(u[7]=t("span",{class:"text-xs t-text-muted"},"停留",-1)),t("input",{type:"number",min:"0",max:"480",step:"15",value:i.stayMinutes,class:"w-14 text-xs text-center border-0 bg-transparent py-0.5 focus:ring-0 font-medium transition-colors",style:{"border-bottom":"1px solid var(--border-color)",color:"var(--text-primary)"},onChange:$},null,40,ke),u[8]||(u[8]=t("span",{class:"text-xs t-text-muted"},"分",-1))])])]),t("div",{class:"flex flex-col gap-1 flex-shrink-0 opacity-0 group-hover:opacity-100 transition-opacity duration-200",onClick:u[3]||(u[3]=tt(()=>{},["stop"]))},[t("button",{type:"button",class:"w-8 h-8 flex items-center justify-center rounded-lg text-cyan-600 hover:bg-cyan-500 hover:text-white transition shadow-sm",style:{background:"var(--nav-active-bg)"},onClick:u[1]||(u[1]=w=>o("insert",i.isLast?null:i.index+1)),title:"在此处插入下一站"},[...u[9]||(u[9]=[t("i",{class:"fas fa-plus text-xs"},null,-1)])]),t("button",{type:"button",class:"w-8 h-8 flex items-center justify-center rounded-lg t-text-muted hover:bg-rose-500/10 hover:text-rose-500 transition shadow-sm",style:{background:"var(--bg-inset)"},onClick:u[2]||(u[2]=w=>o("remove",i.index,i.isLast)),title:"删除此地点"},[...u[10]||(u[10]=[t("i",{class:"fas fa-trash-alt text-xs"},null,-1)])])])])],2)])]))}};function bt(i){return{driving:"fa-car",transit:"fa-bus",walking:"fa-walking",cycling:"fa-bicycle",flight:"fa-plane",train:"fa-train"}[i]||"fa-car"}function $e(i){var e,o,r;return i&&{driving:"驾车",transit:((e=i.details)==null?void 0:e.display_label)==="城际交通"?"城际交通":"公交",walking:"步行",cycling:"骑行",flight:((o=i.details)==null?void 0:o.flight_no)||"航班",train:((r=i.details)==null?void 0:r.train_no)||"高铁"}[i.type]||"驾车"}const _e={class:"transport-connector-row"},De={class:"flex-1 min-w-0 py-1"},Te={class:"font-semibold"},Ce={class:"font-mono text-[11px] opacity-80"},Se={class:"font-mono text-[11px] opacity-60 ml-0.5"},Le={__name:"TransportConnector",props:{segment:{type:Object,required:!0},index:{type:Number,required:!0}},emits:["openDetail"],setup(i,{emit:x}){const e=i,o=x,r=g(()=>bt(e.segment.type)),m=g(()=>$e(e.segment)),k=g(()=>e.segment.type==="flight"||e.segment.type==="train"),$=g(()=>{var c,p;return((c=e.segment.details)==null?void 0:c.departure_time)||((p=e.segment.origin)==null?void 0:p.departure_time)}),f=g(()=>{var c,p;return((c=e.segment.details)==null?void 0:c.arrival_time)||((p=e.segment.destination)==null?void 0:p.arrival_time)}),u=g(()=>$.value&&f.value?`${$.value} → ${f.value}`:$.value||f.value||""),w=g(()=>k.value&&u.value?u.value:e.segment.duration_minutes?gt(e.segment.duration_minutes*60):"--"),y=g(()=>e.segment.distance_km?`${e.segment.distance_km}km`:"--");return(c,p)=>(d(),v("div",_e,[p[3]||(p[3]=t("div",{class:"timeline-rail-spacer"},[t("div",{class:"timeline-line-through"})],-1)),t("div",De,[t("div",{onClick:p[0]||(p[0]=l=>o("openDetail",i.index)),class:"transport-badge group/conn",title:"点击查看详情"},[t("i",{class:N(["fas",r.value,"text-xs"])},null,2),t("span",Te,b(m.value),1),p[1]||(p[1]=t("span",{class:"transport-badge-divider"},null,-1)),t("span",Ce,b(w.value),1),t("span",Se,"("+b(y.value)+")",1),p[2]||(p[2]=t("i",{class:"fas fa-chevron-right text-[10px] opacity-40 ml-1 group-hover/conn:opacity-100 transition-opacity"},null,-1))])])]))}},Ie=["onClick"],je={class:"text-sm font-medium"},Me={__name:"TransportDropdown",props:{show:Boolean,triggerRect:{type:Object,default:null}},emits:["select","close"],setup(i,{emit:x}){const e=i,o=x,r=D(null),m=D({}),k=[{mode:"driving",icon:"fa-car",label:"驾车"},{mode:"transit",icon:"fa-bus",label:"公交/地铁"},{mode:"train",icon:"fa-train",label:"高铁/火车"},{mode:"walking",icon:"fa-walking",label:"步行"},{mode:"cycling",icon:"fa-bicycle",label:"骑行"}];function $(){if(!e.triggerRect)return;const w=e.triggerRect;let y=w.bottom+8;const c=Math.min(w.left,window.innerWidth-170);y+220>window.innerHeight&&(y=w.top-220-8),m.value={top:`${y}px`,left:`${c}px`}}function f(w){r.value&&!r.value.contains(w.target)&&o("close")}rt(()=>{$(),At(()=>document.addEventListener("click",f))}),it(()=>{document.removeEventListener("click",f)});function u(w){o("select",w),o("close")}return(w,y)=>(d(),U(et,{to:"body"},[i.show?(d(),v("div",{key:0,ref_key:"dropdownRef",ref:r,class:"fixed z-[100] rounded-xl shadow-2xl py-1.5 w-40 animate-fade-in",style:Z({...m.value,background:"var(--dropdown-bg)",border:"1px solid var(--dropdown-border)"})},[(d(),v(W,null,J(k,c=>t("button",{key:c.mode,onClick:p=>u(c.mode),class:"w-full text-left px-4 py-2.5 transition flex items-center gap-3 group",style:{color:"var(--dropdown-text)"}},[t("i",{class:N(["fas",c.icon,"w-5 text-center"]),style:{color:"var(--dropdown-icon)"}},null,2),t("span",je,b(c.label),1)],8,Ie)),64))],4)):C("",!0)]))}},Ae={key:0,class:"fixed inset-0 z-[61]"},Be={class:"flex justify-between items-center mb-4"},He={class:"t-text-sub text-sm space-y-3 mb-6"},Oe={class:"py-1.5",style:{"border-bottom":"1px solid var(--border-subtle)"}},Re={class:"flex items-center gap-2 font-medium",style:{color:"var(--text-primary)"}},Pe={class:"py-1.5 flex justify-between",style:{"border-bottom":"1px solid var(--border-subtle)"}},Ne={class:"py-1.5 flex justify-between",style:{"border-bottom":"1px solid var(--border-subtle)"}},Fe={key:0,class:"py-1.5 flex justify-between",style:{"border-bottom":"1px solid var(--border-subtle)"}},Ee={key:1,class:"py-1.5 flex justify-between",style:{"border-bottom":"1px solid var(--border-subtle)"}},ze={class:"py-1.5 flex justify-between",style:{"border-bottom":"1px solid var(--border-subtle)"}},qe={class:"py-1.5 flex justify-between"},Ue={__name:"TransportDetailModal",props:{show:Boolean,segment:{type:Object,default:null}},emits:["close","change"],setup(i,{emit:x}){const e=i,o=x,r=g(()=>{var l;return bt((l=e.segment)==null?void 0:l.type)}),m=g(()=>{var _,T,A;if(!e.segment)return"驾车";const l=e.segment;return{driving:"驾车",transit:((_=l.details)==null?void 0:_.display_label)==="城际交通"?"城际交通":"公交/地铁",walking:"步行",cycling:"骑行",flight:((T=l.details)==null?void 0:T.flight_no)||"航班",train:((A=l.details)==null?void 0:A.train_no)||"高铁/火车"}[l.type]||"驾车"}),k=g(()=>{var l;return(l=e.segment)!=null&&l.duration_minutes?gt(e.segment.duration_minutes*60):"--"}),$=g(()=>{var l;return(l=e.segment)!=null&&l.distance_km?`${e.segment.distance_km} km`:"--"}),f=g(()=>{var l,n,_,T;return((n=(l=e.segment)==null?void 0:l.details)==null?void 0:n.departure_time)||((T=(_=e.segment)==null?void 0:_.origin)==null?void 0:T.departure_time)}),u=g(()=>{var l,n,_,T;return((n=(l=e.segment)==null?void 0:l.details)==null?void 0:n.arrival_time)||((T=(_=e.segment)==null?void 0:_.destination)==null?void 0:T.arrival_time)}),w=g(()=>{var l,n;return((n=(l=e.segment)==null?void 0:l.origin)==null?void 0:n.name)||"起点"}),y=g(()=>{var l,n;return((n=(l=e.segment)==null?void 0:l.destination)==null?void 0:n.name)||"终点"}),c=g(()=>{var l,n;return((l=e.segment)==null?void 0:l.type)==="flight"||((n=e.segment)==null?void 0:n.type)==="train"}),p=g(()=>{var l,n,_,T,A,z;return((l=e.segment)==null?void 0:l.type)==="flight"&&((_=(n=e.segment)==null?void 0:n.details)==null?void 0:_.flight_no)||((T=e.segment)==null?void 0:T.type)==="train"&&((z=(A=e.segment)==null?void 0:A.details)==null?void 0:z.train_no)});return(l,n)=>{var _;return d(),U(et,{to:"body"},[i.show&&i.segment?(d(),v("div",Ae,[t("div",{class:"absolute inset-0 backdrop-blur-sm",style:{background:"var(--modal-overlay)"},onClick:n[0]||(n[0]=T=>o("close"))}),t("div",{class:"absolute bottom-0 left-0 right-0 md:top-1/2 md:left-1/2 md:bottom-auto md:-translate-x-1/2 md:-translate-y-1/2 md:w-[400px] max-h-[90vh] overflow-y-auto md:rounded-2xl rounded-t-2xl shadow-2xl p-6",style:{background:"var(--modal-bg)"},onClick:n[3]||(n[3]=tt(()=>{},["stop"]))},[t("div",Be,[n[5]||(n[5]=t("h3",{class:"text-lg font-bold t-heading"},"交通方式详情",-1)),t("button",{type:"button",onClick:n[1]||(n[1]=T=>o("close")),class:"w-8 h-8 flex items-center justify-center rounded-full t-text-sub transition",style:{background:"var(--bg-inset)"}},[...n[4]||(n[4]=[t("i",{class:"fas fa-times"},null,-1)])])]),t("div",He,[t("div",Oe,[t("div",Re,[t("i",{class:N(["fas",r.value,"text-cyan-600"])},null,2),H(" "+b(m.value),1)])]),t("div",Pe,[n[6]||(n[6]=t("span",{class:"t-text-muted"},"起点",-1)),t("span",null,b(w.value),1)]),t("div",Ne,[n[7]||(n[7]=t("span",{class:"t-text-muted"},"终点",-1)),t("span",null,b(y.value),1)]),c.value&&(f.value||u.value)?(d(),v("div",Fe,[n[8]||(n[8]=t("span",{class:"t-text-muted"},"时间",-1)),t("span",null,b(f.value||"--")+" → "+b(u.value||"--"),1)])):C("",!0),c.value&&((_=i.segment.details)!=null&&_.seat_info)?(d(),v("div",Ee,[n[9]||(n[9]=t("span",{class:"t-text-muted"},"座位",-1)),t("span",null,b(i.segment.details.seat_info),1)])):C("",!0),t("div",ze,[n[10]||(n[10]=t("span",{class:"t-text-muted"},"时长",-1)),t("span",null,b(k.value),1)]),t("div",qe,[n[11]||(n[11]=t("span",{class:"t-text-muted"},"距离",-1)),t("span",null,b($.value),1)])]),p.value?C("",!0):(d(),v("button",{key:0,type:"button",class:"w-full py-3 rounded-xl border-2 border-cyan-500 text-cyan-600 font-medium transition",onClick:n[2]||(n[2]=T=>o("change"))},[...n[12]||(n[12]=[t("i",{class:"fas fa-exchange-alt mr-2"},null,-1),H(" 更改交通方式 ",-1)])]))])])):C("",!0)])}}},Ve={key:0,class:"fixed inset-0 z-[60] flex items-center justify-center"},We={class:"flex justify-between items-center mb-6"},Ge={class:"text-lg font-bold t-heading"},Je={__name:"BaseModal",props:{show:Boolean,title:{type:String,default:""},maxWidth:{type:String,default:"500px"}},emits:["close"],setup(i,{emit:x}){const e=x;return(o,r)=>(d(),U(et,{to:"body"},[i.show?(d(),v("div",Ve,[t("div",{class:"absolute inset-0 backdrop-blur-sm transition-opacity",style:{background:"var(--modal-overlay)"},onClick:r[0]||(r[0]=m=>e("close"))}),t("div",{class:"relative w-[calc(100%-2rem)] rounded-2xl shadow-2xl p-6 animate-fade-in",style:Z({maxWidth:i.maxWidth,background:"var(--modal-bg)"})},[t("div",We,[t("h3",Ge,b(i.title),1),t("button",{onClick:r[1]||(r[1]=m=>e("close")),class:"w-8 h-8 flex items-center justify-center rounded-full t-text-sub transition",style:{background:"var(--bg-inset)"}},[...r[2]||(r[2]=[t("i",{class:"fas fa-times"},null,-1)])])]),Bt(o.$slots,"default")],4)])):C("",!0)]))}},Ke={class:"relative mb-4"},Qe={class:"flex gap-2 mb-4 overflow-x-auto pb-2"},Xe={class:"h-64 overflow-y-auto space-y-2"},Ye={key:0,class:"text-center py-4 t-text-muted"},Ze={key:1,class:"text-center t-text-muted py-10"},tn={key:0,class:"text-xs mt-1 text-cyan-600"},en={key:2,class:"text-center py-4 t-text-muted"},nn=["onClick"],sn={class:"font-medium text-sm t-text"},an={class:"text-xs t-text-muted truncate w-64"},ln={__name:"AddLocationModal",props:{show:Boolean,city:{type:String,default:""},insertAtIndex:{type:[Number,null],default:null}},emits:["close","select","openTicketImport"],setup(i,{emit:x}){const e=i,o=x,r=D(""),m=D([]),k=D(!1);let $=null;function f(y){$&&clearTimeout($),y.trim()&&($=setTimeout(async()=>{k.value=!0;try{m.value=await Wt(y,e.city)}catch(c){console.error(c)}finally{k.value=!1}},500))}function u(y){o("select",{name:y.name,address:y.address,city:y.city||e.city||"",lat:y.location?parseFloat(y.location.split(",")[1]):null,lng:y.location?parseFloat(y.location.split(",")[0]):null})}function w(){r.value="",m.value=[],o("close")}return(y,c)=>(d(),U(Je,{show:i.show,title:"添加行程地点",onClose:w},{default:Ht(()=>[t("div",Ke,[c[3]||(c[3]=t("i",{class:"fas fa-search absolute left-4 top-1/2 -translate-y-1/2 t-text-muted"},null,-1)),Ot(t("input",{"onUpdate:modelValue":c[0]||(c[0]=p=>r.value=p),type:"text",placeholder:"搜索地点...",class:"w-full pl-11 pr-4 py-3 rounded-xl border outline-none transition",onInput:c[1]||(c[1]=p=>f(r.value))},null,544),[[Rt,r.value]])]),t("div",Qe,[c[5]||(c[5]=t("button",{class:"flex-shrink-0 px-3 py-1.5 text-cyan-600 text-xs rounded-lg font-medium flex items-center gap-1",style:{background:"var(--nav-active-bg)",border:"1px solid rgba(6,182,212,0.2)"}},[t("i",{class:"fas fa-search"}),H(" 搜索 ")],-1)),t("button",{type:"button",onClick:c[2]||(c[2]=p=>{w(),o("openTicketImport")}),class:"flex-shrink-0 px-3 py-1.5 text-cyan-600 text-xs rounded-lg font-medium flex items-center gap-1 transition",style:{background:"var(--nav-active-bg)",border:"1px solid rgba(6,182,212,0.2)"}},[...c[4]||(c[4]=[t("i",{class:"fas fa-camera"},null,-1),H(" 截图导入 ",-1)])])]),t("div",Xe,[k.value?(d(),v("div",Ye,[...c[6]||(c[6]=[t("i",{class:"fas fa-spinner fa-spin"},null,-1),H(" 搜索中... ",-1)])])):m.value.length===0&&!r.value?(d(),v("div",Ze,[c[7]||(c[7]=t("i",{class:"fas fa-map-marked-alt text-3xl mb-2 opacity-50"},null,-1)),c[8]||(c[8]=t("p",{class:"text-sm"},"输入关键词搜索地点",-1)),i.insertAtIndex!==null?(d(),v("p",tn,"将添加为当前站点的下一站")):C("",!0)])):m.value.length===0?(d(),v("div",en,"未找到相关地点")):C("",!0),(d(!0),v(W,null,J(m.value,p=>(d(),v("div",{key:p.name+p.address,onClick:l=>u(p),class:"p-3 rounded-lg cursor-pointer transition flex items-center gap-3",style:{"border-bottom":"1px solid var(--border-subtle)"}},[c[9]||(c[9]=t("div",{class:"w-8 h-8 rounded-full flex items-center justify-center t-text-muted flex-shrink-0",style:{background:"var(--bg-inset)"}},[t("i",{class:"fas fa-map-pin"})],-1)),t("div",null,[t("div",sn,b(p.name),1),t("div",an,b(p.district||"")+" "+b(p.address||""),1)])],8,nn))),128))])]),_:1},8,["show"]))}},on={key:0,class:"fixed inset-0 z-[70]"},rn={key:0},un=["src"],dn={key:0,class:"mt-3 text-sm text-cyan-600"},cn={key:1,class:"mt-3 text-sm text-red-500"},mn=["disabled"],vn={__name:"TicketImportModal",props:{show:Boolean},emits:["close","imported"],setup(i,{emit:x}){const e=i,o=x,r=D(null),m=D(""),k=D(""),$=D(!1);let f=null;function u(l){const n=new FileReader;n.onload=()=>{r.value=n.result,k.value=""},n.readAsDataURL(l)}function w(l){const n=l.target.files[0];n&&n.type.startsWith("image/")&&u(n)}function y(){var l;(l=document.getElementById("ticket-file-input"))==null||l.click()}async function c(){if(r.value){$.value=!0,m.value="正在识别票据…",k.value="";try{const l=await qt(r.value);if(l.type==="unknown"||l.error){k.value=l.error||"无法识别为机票或火车票",m.value="";return}m.value="已加入当天行程",o("imported",l),o("close")}catch(l){k.value=l.message||"识别失败，请重试",m.value=""}finally{$.value=!1}}}function p(){r.value=null,m.value="",k.value="",o("close")}return rt(()=>{f=l=>{var n,_;if(e.show&&((_=(n=l.clipboardData)==null?void 0:n.files)!=null&&_.length)){const T=Array.from(l.clipboardData.files).find(A=>A.type.startsWith("image/"));T&&(l.preventDefault(),u(T))}},window.addEventListener("paste",f)}),it(()=>{f&&window.removeEventListener("paste",f)}),(l,n)=>(d(),U(et,{to:"body"},[i.show?(d(),v("div",on,[t("div",{class:"absolute inset-0 backdrop-blur-sm",style:{background:"var(--modal-overlay)"},onClick:p}),t("div",{class:"absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[calc(100%-2rem)] max-w-md rounded-2xl shadow-2xl p-6",style:{background:"var(--modal-bg)"},onClick:n[0]||(n[0]=tt(()=>{},["stop"]))},[t("div",{class:"flex justify-between items-center mb-4"},[n[2]||(n[2]=t("h3",{class:"text-lg font-bold t-heading"},"导入航班 / 车票",-1)),t("button",{type:"button",onClick:p,class:"w-8 h-8 flex items-center justify-center rounded-full t-text-sub transition",style:{background:"var(--bg-inset)"}},[...n[1]||(n[1]=[t("i",{class:"fas fa-times"},null,-1)])])]),n[4]||(n[4]=t("p",{class:"text-sm t-text-sub mb-3"},"上传或粘贴机票、高铁票等截图，自动识别并加入当天行程",-1)),t("div",{onClick:y,class:"border-2 border-dashed rounded-xl p-6 text-center cursor-pointer hover:border-cyan-400 transition",style:{"border-color":"var(--border-color)"}},[t("input",{id:"ticket-file-input",type:"file",accept:"image/*",class:"hidden",onChange:w},null,32),r.value?(d(),v("img",{key:1,src:r.value,class:"max-h-48 mx-auto rounded-lg object-contain",alt:"预览"},null,8,un)):(d(),v("div",rn,[...n[3]||(n[3]=[t("i",{class:"fas fa-image text-4xl t-text-muted mb-2"},null,-1),t("p",{class:"text-sm t-text-sub"},[H("点击选择或 "),t("kbd",{class:"px-1.5 py-0.5 rounded text-xs",style:{background:"var(--bg-inset)"}},"Ctrl+V"),H(" 粘贴截图")],-1)])]))]),m.value?(d(),v("div",dn,b(m.value),1)):C("",!0),k.value?(d(),v("div",cn,b(k.value),1)):C("",!0),t("button",{type:"button",disabled:!r.value||$.value,class:N(["mt-4 w-full py-3 rounded-xl bg-primary text-white font-medium transition",{"opacity-50 cursor-not-allowed":!r.value||$.value}]),onClick:c},b($.value?"识别中...":"识别并导入"),11,mn)])])):C("",!0)]))}},pn={class:"max-w-6xl mx-auto"},fn={key:0,class:"text-center py-20 t-text-muted animate-fade-in"},xn={key:1,class:"animate-fade-in"},yn={class:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6"},gn={class:"flex items-center gap-3 mb-1"},bn={class:"text-2xl font-bold t-heading"},hn={class:"glass-panel rounded-xl p-4 mb-6 flex flex-wrap gap-4 items-center"},wn={class:"flex items-center gap-2"},kn=["value"],$n={class:"flex items-center gap-2"},_n=["value"],Dn={key:0,class:"flex items-center gap-2"},Tn=["value"],Cn={key:1,class:"max-w-3xl mx-auto"},Sn={key:0,class:"space-y-0"},Ln=["onDragstart","onDragover","onDrop"],In=["data-seg-idx"],jn={class:"mt-6 text-center"},Rn={__name:"PlanDetailView",setup(i){const x=Ft(),e=Et(),o=nt(),r=Pt(),{dragIndex:m,dragOverIndex:k,onDragStart:$,onDragOver:f,onDragLeave:u,onDrop:w,onDragEnd:y}=Gt(),c=D(!0),p=D(!1),l=D(null),n=D(!1),_=D(!1),T=D(null),A=D(-1),z=D(!1),ut=D(null),st=D(-1);let G=null;const O=g(()=>o.activePlan),F=g(()=>{var a;return((a=O.value)==null?void 0:a.days)||[]}),dt=g(()=>o.activeDetailTab==="overview"),R=g(()=>o.getCurrentDayIndex()),q=g(()=>F.value[R.value]||null),L=g(()=>{var a;return((a=q.value)==null?void 0:a.segments)||[]}),E=g(()=>q.value?(Y(q.value),zt(q.value)):[]),ht=g(()=>L.value.length>0||o.tempStartLocation);rt(async()=>{var a,s,I;try{const j=x.params.id;if(((a=o.activePlan)==null?void 0:a.id)!==j){const B=await Ut(j);o.activePlan=B}o.activeDetailTab=0,(I=(s=O.value)==null?void 0:s.days)==null||I.forEach(B=>Y(B))}catch{r.showToast("加载行程失败","error"),e.push({name:"plans"})}finally{c.value=!1}}),it(()=>{G&&clearTimeout(G)}),Nt(()=>O.value,()=>{!O.value||c.value||(G&&clearTimeout(G),G=setTimeout(()=>o.saveActivePlanSilently(),2e3))},{deep:!0});function wt(a){o.updatePlanDepartureDate(a.target.value)}function kt(a){const s=parseInt(a.target.value,10)||1;o.updatePlanDaysCount(s)}function $t(a){q.value&&(q.value.start_time_hm=a.target.value||"08:00")}function at(a,s,I){const j=F.value[a];j&&(Y(j),j.location_stay_minutes[s]!==void 0&&(j.location_stay_minutes[s]=I))}function K(a=null){l.value=a,p.value=!0}async function _t(a){var B;p.value=!1;const s=R.value,I=F.value[s].segments;if(!a.city&&((B=O.value.start_location)!=null&&B.city)&&(a.city=O.value.start_location.city),I.length===0&&!o.tempStartLocation){o.tempStartLocation=a,s===0&&(O.value.start_location={name:a.name,lat:a.lat,lng:a.lng,address:a.address,city:a.city}),r.showToast("起点设置成功");return}if(I.length===0&&o.tempStartLocation){await o.addSegment(o.tempStartLocation,a),o.tempStartLocation=null,r.showToast("地点已添加");return}if(l.value!==null){await o.insertSegmentAt(l.value,a),r.showToast("地点已插入");return}const j=I[I.length-1].destination;await o.addSegment(j,a),r.showToast("地点已添加")}async function lt(a,s){confirm("确定要删除这个地点吗？")&&(await o.removeLocation(a,s),r.showToast("地点已删除"))}function Dt(a){A.value=a,T.value=L.value[a],_.value=!0}function Tt(){_.value=!1,A.value>=0&&Ct(A.value)}function Ct(a){const s=document.querySelector(`[data-seg-idx="${a}"]`),I=(s==null?void 0:s.getBoundingClientRect())||{top:200,left:200,bottom:240,right:300};ut.value=I,st.value=a,z.value=!0}async function St(a){if(z.value=!1,!(st.value<0))try{await o.changeTransportMode(st.value,a),r.showToast("交通方式已更新")}catch{r.showToast("切换交通方式失败","error")}}function Lt(){p.value=!1,n.value=!0}async function It(a){n.value=!1;const s=R.value,I=F.value[s].segments,j={name:a.departure_station||a.departure_city||"出发地",city:a.departure_city||"",departure_time:a.departure_time},B={name:a.arrival_station||a.arrival_city||"目的地",city:a.arrival_city||"",arrival_time:a.arrival_time},Q=a.duration_seconds?Math.round(a.duration_seconds/60):0,X={type:a.type||"train",origin:j,destination:B,distance_km:a.distance_km||0,duration_minutes:Q,details:{flight_no:a.flight_no,train_no:a.train_no,departure_time:a.departure_time,arrival_time:a.arrival_time,seat_info:a.seat_info}};I.push(X),Y(F.value[s]),r.showToast("票据已导入"),o.saveActivePlanSilently()}async function jt(){try{await o.saveActivePlan(),r.showToast("行程已保存")}catch{r.showToast("保存失败","error")}}async function Mt(){if(confirm("确定要删除整个行程吗？此操作不可恢复。"))try{await Vt(O.value.id),r.showToast("行程已删除"),e.push({name:"plans"})}catch{r.showToast("删除失败","error")}}return(a,s)=>{var I,j,B,Q,X,ct,mt,vt,pt;return d(),v("div",pn,[c.value?(d(),v("div",fn,[...s[13]||(s[13]=[t("i",{class:"fas fa-spinner fa-spin text-4xl text-cyan-500 mb-4"},null,-1),t("p",{class:"text-lg"},"加载行程...",-1)])])):O.value?(d(),v("div",xn,[t("div",yn,[t("div",null,[t("div",gn,[t("button",{onClick:s[0]||(s[0]=S=>h(e).push({name:"plans"})),class:"t-text-muted hover:text-cyan-500 transition"},[...s[14]||(s[14]=[t("i",{class:"fas fa-arrow-left mr-1"},null,-1),H(" 返回 ",-1)])])]),t("h1",bn,b(O.value.title||"未命名行程"),1)]),t("div",{class:"flex items-center gap-2 flex-wrap"},[t("button",{onClick:jt,class:"px-4 py-2 bg-gradient-to-r from-cyan-600 to-blue-600 text-white rounded-lg hover:shadow-lg transition flex items-center gap-2 font-medium text-sm"},[...s[15]||(s[15]=[t("i",{class:"fas fa-save"},null,-1),H(" 保存 ",-1)])]),t("button",{onClick:Mt,class:"px-4 py-2 rounded-lg border transition t-text-sub hover:text-red-500 hover:border-red-400 text-sm",style:{"border-color":"var(--border-color)"}},[...s[16]||(s[16]=[t("i",{class:"fas fa-trash-alt mr-1"},null,-1),H(" 删除 ",-1)])])])]),t("div",hn,[t("div",wn,[s[17]||(s[17]=t("i",{class:"far fa-calendar-alt text-cyan-500"},null,-1)),s[18]||(s[18]=t("label",{class:"text-xs t-text-muted font-medium"},"出发日期",-1)),t("input",{type:"date",value:((I=F.value[0])==null?void 0:I.date)||"",class:"rounded-lg px-3 py-1.5 text-sm border outline-none",onChange:wt},null,40,kn)]),t("div",$n,[s[19]||(s[19]=t("i",{class:"fas fa-hashtag text-cyan-500"},null,-1)),s[20]||(s[20]=t("label",{class:"text-xs t-text-muted font-medium"},"天数",-1)),t("input",{type:"number",value:F.value.length,min:"1",max:"30",class:"w-16 rounded-lg px-3 py-1.5 text-sm border outline-none text-center",onChange:kt},null,40,_n)]),dt.value?C("",!0):(d(),v("div",Dn,[s[21]||(s[21]=t("i",{class:"far fa-clock text-cyan-500"},null,-1)),s[22]||(s[22]=t("label",{class:"text-xs t-text-muted font-medium"},"当日出发时间",-1)),t("input",{type:"time",value:((j=q.value)==null?void 0:j.start_time_hm)||"08:00",class:"rounded-lg px-3 py-1.5 text-sm border outline-none",onChange:$t},null,40,Tn)]))]),V(Xt,{days:F.value},null,8,["days"]),dt.value?(d(),U(ae,{key:0,days:F.value},null,8,["days"])):(d(),v("div",Cn,[ht.value?(d(),v("div",Sn,[L.value.length===0&&h(o).tempStartLocation?(d(),U(ot,{key:0,location:h(o).tempStartLocation,index:0,"is-last":!0,"role-label":R.value===0?"起点":null,"arrival-hm":((B=E.value[0])==null?void 0:B.arrivalHm)||"--","stay-minutes":((Q=E.value[0])==null?void 0:Q.stayMinutes)||0,"departure-hm":(X=E.value[0])==null?void 0:X.departureHm,"day-index":R.value,onInsert:K,onRemove:lt,onUpdateStay:at},null,8,["location","role-label","arrival-hm","stay-minutes","departure-hm","day-index"])):C("",!0),(d(!0),v(W,null,J(L.value,(S,M)=>{var ft,xt,yt;return d(),v(W,{key:M},[t("div",{draggable:"true",onDragstart:P=>h($)(P,M),onDragover:P=>h(f)(P,M),onDragleave:s[1]||(s[1]=(...P)=>h(u)&&h(u)(...P)),onDrop:P=>h(w)(P,M,R.value),onDragend:s[2]||(s[2]=(...P)=>h(y)&&h(y)(...P)),class:N({"opacity-50":h(m)===M,"ring-2 ring-cyan-400 rounded-xl":h(k)===M})},[V(ot,{location:S.origin,index:M,"is-last":!1,"role-label":M===0&&R.value===0?"起点":null,"arrival-hm":((ft=E.value[M])==null?void 0:ft.arrivalHm)||"--","stay-minutes":((xt=E.value[M])==null?void 0:xt.stayMinutes)||0,"departure-hm":(yt=E.value[M])==null?void 0:yt.departureHm,"day-index":R.value,onInsert:K,onRemove:lt,onUpdateStay:at},null,8,["location","index","role-label","arrival-hm","stay-minutes","departure-hm","day-index"])],42,Ln),t("div",{"data-seg-idx":M},[V(Le,{segment:S,index:M,onOpenDetail:P=>Dt(M)},null,8,["segment","index","onOpenDetail"])],8,In)],64)}),128)),L.value.length>0?(d(),v("div",{key:1,draggable:"true",onDragstart:s[3]||(s[3]=S=>h($)(S,L.value.length)),onDragover:s[4]||(s[4]=S=>h(f)(S,L.value.length)),onDragleave:s[5]||(s[5]=(...S)=>h(u)&&h(u)(...S)),onDrop:s[6]||(s[6]=S=>h(w)(S,L.value.length,R.value)),onDragend:s[7]||(s[7]=(...S)=>h(y)&&h(y)(...S)),class:N({"opacity-50":h(m)===L.value.length,"ring-2 ring-cyan-400 rounded-xl":h(k)===L.value.length})},[V(ot,{location:L.value[L.value.length-1].destination,index:L.value.length,"is-last":!0,"role-label":"终点","arrival-hm":((ct=E.value[L.value.length])==null?void 0:ct.arrivalHm)||"--","stay-minutes":((mt=E.value[L.value.length])==null?void 0:mt.stayMinutes)||0,"departure-hm":(vt=E.value[L.value.length])==null?void 0:vt.departureHm,"day-index":R.value,onInsert:K,onRemove:lt,onUpdateStay:at},null,8,["location","index","arrival-hm","stay-minutes","departure-hm","day-index"])],34)):C("",!0)])):C("",!0),t("div",jn,[t("button",{type:"button",onClick:s[8]||(s[8]=S=>K(null)),class:"px-6 py-3 border-2 border-dashed border-cyan-400/50 rounded-xl text-cyan-500 hover:bg-cyan-500/10 hover:border-cyan-400 transition flex items-center gap-2 mx-auto"},[...s[23]||(s[23]=[t("i",{class:"fas fa-plus"},null,-1),H(" 添加下一站目的地 ",-1)])])])]))])):C("",!0),V(ln,{show:p.value,city:((pt=q.value)==null?void 0:pt.city)||"","insert-at-index":l.value,onClose:s[9]||(s[9]=S=>p.value=!1),onSelect:_t,onOpenTicketImport:Lt},null,8,["show","city","insert-at-index"]),V(vn,{show:n.value,onClose:s[10]||(s[10]=S=>n.value=!1),onImported:It},null,8,["show"]),V(Ue,{show:_.value,segment:T.value,onClose:s[11]||(s[11]=S=>_.value=!1),onChange:Tt},null,8,["show","segment"]),z.value?(d(),U(Me,{key:2,show:z.value,"trigger-rect":ut.value,onSelect:St,onClose:s[12]||(s[12]=S=>z.value=!1)},null,8,["show","trigger-rect"])):C("",!0)])}}};export{Rn as default};
